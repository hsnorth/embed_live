<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montreal Mayoral Alignment Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- Bloomberg-Inspired Design --- */
        :root {
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            
            --color-text: #191919;
            --color-text-light: #5b5b5b;
            --color-accent: #e0007a; /* Bloomberg Magenta */
            --color-border: #dcdcdc;
            --color-bg: #ffffff;
            --color-bg-light: #f4f4f4;
            --color-error: #d90000;
            --color-success: #008a1e;
        }
        
        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            margin: 0;
            padding: 2rem 1rem;
            background-color: var(--color-bg-light);
            color: var(--color-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 760px;
            margin: auto;
            background: var(--color-bg);
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .card-content {
            padding: 2.5rem 3rem 3rem 3rem;
        }

        /* --- Card Visibility --- */
        .quiz-card {
            display: none; /* All cards hidden by default */
        }
        .quiz-card.active {
            display: block; /* Active card is shown */
        }
        
        /* --- Header & Start Card --- */
        #start-card h1 {
            font-family: var(--font-sans);
            font-weight: 800;
            color: var(--color-text);
            margin: 0 0 1rem 0;
            font-size: 2.5rem;
            line-height: 1.2;
            text-align: center;
        }
        
        #start-card p {
            font-size: 1.1rem;
            color: var(--color-text-light);
            margin: 1.5rem 0;
            text-align: center;
        }

        .how-it-works {
            background: var(--color-bg-light);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 1.5rem 2.5rem;
            margin-top: 2.5rem;
        }
        
        .how-it-works h2 {
            font-weight: 700;
            color: var(--color-text);
            text-align: center;
            margin: 0.5rem 0 1.5rem 0;
            font-size: 1.25rem;
        }
        
        .how-it-works ol {
            padding-left: 20px;
            margin: 0;
        }
        
        .how-it-works li {
            font-size: 1rem;
            color: var(--color-text-secondary);
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .how-it-works li:last-child { margin-bottom: 0; }
        .how-it-works strong { color: var(--color-text); }

        #start-btn {
            background-color: var(--color-accent);
            color: var(--color-bg);
            font-size: 1.1rem;
            font-weight: 700;
            width: 100%;
            margin-top: 2rem;
        }
        
        /* --- Quiz Progress Bar --- */
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: var(--color-border);
        }
        
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--color-accent);
            transition: width 0.3s ease;
        }

        /* --- Question Card Styling --- */
        .question-header {
            font-size: 1rem;
            font-weight: 700;
            color: var(--color-accent);
            margin-bottom: 1rem;
        }
        
        .question-text {
            font-weight: 700;
            font-size: 1.75rem;
            line-height: 1.4;
            color: var(--color-text);
            margin-bottom: 2.5rem;
        }
        
        /* --- Custom Radio Buttons (Bloomberg Style) --- */
        .radio-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        @media (min-width: 600px) {
            .radio-group {
                grid-template-columns: repeat(3, 1fr);
            }
            .radio-group .radio-label:nth-child(1),
            .radio-group .radio-label:nth-child(2) { grid-column: span 3; }
            .radio-group .radio-label:nth-child(3),
            .radio-group .radio-label:nth-child(4),
            .radio-group .radio-label:nth-child(5) { grid-column: span 1; }
            
            /* Re-order for SD/D/N/A/SA on desktop */
            .radio-group .radio-label:nth-child(1) { order: 1; grid-column: 1 / 2; }
            .radio-group .radio-label:nth-child(2) { order: 2; grid-column: 2 / 3; }
            .radio-group .radio-label:nth-child(3) { order: 3; grid-column: 3 / 4; }
            .radio-group .radio-label:nth-child(4) { order: 4; grid-column: 4 / 5; }
            .radio-group .radio-label:nth-child(5) { order: 5; grid-column: 5 / 6; }
            .radio-group { grid-template-columns: repeat(5, 1fr); }
        }


        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            text-align: center;
            padding: 0.85rem 0.5rem;
            border: 2px solid var(--color-border);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-text-secondary);
            transition: all 0.2s ease-in-out;
        }
        
        .radio-group label:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .radio-group input[type="radio"]:checked + label {
            background-color: var(--color-bg);
            color: var(--color-accent);
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px var(--color-accent);
        }
        
        /* --- Accordion --- */
        .accordion-container {
            margin-top: 2.5rem;
            border-top: 1px solid var(--color-border);
            padding-top: 1.5rem;
        }
        
        details { margin-bottom: 0.5rem; }
        
        summary {
            font-weight: 700;
            color: var(--color-text);
            cursor: pointer;
            list-style: none; /* Remove default marker */
            position: relative;
            padding-left: 1.75rem;
        }
        
        summary::before {
            content: '+';
            font-weight: 700;
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-accent);
            font-size: 1.2rem;
        }
        
        details[open] summary::before {
            content: 'â€“';
        }
        
        .accordion-content {
            padding: 0.75rem 0 0.5rem 1.75rem;
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        /* --- Navigation --- */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 3rem;
            border-top: 1px solid var(--color-border);
            padding-top: 2rem;
        }

        .nav-btn, #start-btn, #submit-quiz-btn {
            font-family: var(--font-sans);
            font-size: 1rem;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--color-text);
            border-radius: 4px;
            background: var(--color-text);
            color: var(--color-bg);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-btn:hover, #start-btn:hover, #submit-quiz-btn:hover {
            background: #333;
            border-color: #333;
        }
        
        .nav-btn.secondary {
            background: var(--color-bg);
            color: var(--color-text);
        }
        
        .nav-btn.secondary:hover {
            background: #f4f4f4;
        }
        
        .nav-btn:disabled, #submit-quiz-btn:disabled {
            background: #ccc;
            border-color: #ccc;
            color: #888;
            cursor: not-allowed;
        }

        /* --- Weighting Card --- */
        #weighting-card h2 {
            font-weight: 800;
            font-size: 2.5rem;
            line-height: 1.2;
            color: var(--color-text);
            text-align: center;
            margin-bottom: 1rem;
        }
        #weighting-card .card-subtitle {
            font-size: 1.1rem;
            color: var(--color-text-light);
            text-align: center;
            margin-bottom: 2rem;
        }

        .points-tracker {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(5px);
            padding: 1.5rem;
            z-index: 10;
            text-align: center;
            border-bottom: 1px solid var(--color-border);
            margin: -2.5rem -3rem 2rem -3rem;
        }
        
        .points-tracker-label {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--color-text);
            display: block;
            margin-bottom: 0.5rem;
        }
        
        #total-points-display {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-success);
            transition: color 0.3s ease;
        }
        #total-points-display.error { color: var(--color-error); }
        
        #points-helper {
            font-size: 1rem;
            color: var(--color-text-light);
            margin-top: 0.5rem;
            line-height: 1.5;
        }
        
        .weighting-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 0;
            border-bottom: 1px solid var(--color-border);
        }
        .weighting-list-item:last-child { border-bottom: none; }
        
        .weighting-q-text {
            font-weight: 500;
            padding-right: 1rem;
            flex-grow: 1;
        }
        
        .weighting-q-text strong {
            font-weight: 700;
            color: var(--color-text);
        }
        
        .point-input {
            width: 70px;
            height: 48px;
            font-size: 1.2rem;
            font-weight: 700;
            text-align: center;
            border: 2px solid var(--color-border);
            border-radius: 4px;
            box-sizing: border-box; 
            transition: border-color 0.3s, box-shadow 0.3s;
            flex-shrink: 0;
        }
        
        .point-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px var(--color-accent);
        }

        #submit-quiz-btn {
            width: 100%;
            background: var(--color-accent);
            border-color: var(--color-accent);
            color: var(--color-bg);
            margin-top: 2rem;
        }
        #submit-quiz-btn:hover { background: #b90062; border-color: #b90062; }
        
        #error-message {
            color: var(--color-error);
            text-align: center;
            font-weight: 700;
            margin-top: 1.5rem;
            font-size: 1.1rem;
            display: none; /* Hidden by default */
        }

        /* --- Results Card --- */
        #results-card h2 {
            font-weight: 800;
            font-size: 2.5rem;
            line-height: 1.2;
            color: var(--color-text);
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        .result-bar { margin-bottom: 1.5rem; }
        .result-bar-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        .candidate-name { font-size: 1.1rem; color: var(--color-text); }
        .result-percent { font-size: 1.1rem; color: var(--color-text-secondary); }
        .bar-wrapper {
            height: 28px;
            background: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: var(--color-text-light);
            width: 0%; /* Set by JS */
            transition: width 1.5s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .result-bar.top-match .bar-fill {
            background: var(--color-accent); /* Top match is accent color */
        }
        .result-bar.top-match .candidate-name,
        .result-bar.top-match .result-percent {
            font-weight: 700;
            color: var(--color-accent);
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="start-card" class="quiz-card active">
            <div class="card-content">
                <h1>Which Montreal Mayoral Candidate Thinks Like You?</h1>
                <p>Answer 20 questions on key city issues to find out which 2025 mayoral platform best matches your priorities.</p>

                <div class="how-it-works">
                    <h2>How It Works</h2>
                    <ol>
                        <li><strong>Share Your Opinion:</strong> For 20 questions, pick the answer that best fits how you feel (from "Strongly Disagree" to "Strongly Agree").</li>
                        <li><strong>Show What Matters Most:</strong> After, you'll get 100 "Importance Points." You must spend all 100 points across the questions to show which ones are most important to you.</li>
                        <li><strong>Find Your Match!</strong> We'll instantly compare your answers and priorities to the candidates' platforms and show you who you align with most.</li>
                    </ol>
                </div>
                
                <button id="start-btn">Start Quiz</button>
            </div>
        </div>
        
        <div id="question-card-container"></div>
        
        <div id="weighting-card" class="quiz-card">
            <div class="card-content">
                <h2>How important is each question?</h2>
                <p class="card-subtitle">You have 100 points to show what matters most. Give more points to the questions you care about, and fewer to the ones you don't.</p>
                
                <div class="points-tracker">
                    <span class="points-tracker-label">Your Importance Budget</span>
                    <span id="total-points-display">0 / 100</span>
                    <div id="points-helper">All questions start at 5 points. You must use <strong>exactly 100</strong>.</div>
                </div>

                <div id="weighting-list">
                    </div>

                <button id="submit-quiz-btn" disabled>Calculate My Alignment</button>
                <p id="error-message"></p>
            </div>
        </div>

        <div id="results-card" class="quiz-card">
            <div class="card-content">
                <h2>Your Closest Alignments</h2>
                <div id="results-output">
                    </div>
            </div>
        </div>

    </div>

    <script>
        // --- Data Setup ---

        // Candidate data: Key is the candidate, Value is an array of their scores for Q1 to Q20
        // Scores based on the grid: SD=-2, D=-1, N=0, A=1, SA=2
        const CANDIDATE_SCORES = {
            'Luc Rabouin (Projet MontrÃ©al)':              [2, -2, 1, -1, -1, -2, 1, -1, -1, -2, 1, 1, -1, -1, -2, 1,  2,  2,  2,  2],
            'Soraya Martinez Ferrada (Ensemble MontrÃ©al)': [-1, -1, 1, -1, -2, -1, 1, -2, -1, -2, 1, -1, 1, -2, -1, -2, -2, -1, -1,  1],
            'Craig SauvÃ© (Transition MontrÃ©al)':           [2, -2, -1,  2,  2, -2, 2,  2,  2,  2, 2,  2,  2,  2, -2,  2,  1,  1,  1, -2],
            'Gilbert Thibodeau (Action MontrÃ©al)':         [-2,  2,  2, -2,  0,  2, -1, -2, -2, -1, 1, -1,  2, -2,  2, -2, -2, -2,  0, -2],
            'Jean-FranÃ§ois Kacou (Futur MontrÃ©al)':      [-2,  2,  0, -1,  0, -1, -1,  0,  1, -1, 0, -1,  1, -1, -1, -2,  0, -1,  0, -1]
        };

        // Quiz Questions: 20 total, now with accordion details
        const QUESTIONS = [
            // --- Mobility (1-2) ---
            { 
                id: 1, 
                text: "The city must **immediately expand the RÃ©seau express vÃ©lo (REV)**, adding specialized options like Bixi baby seats and rapid bus lanes on major arteries.",
                details: [
                    { summary: "What is the REV?", content: "The RÃ©seau express vÃ©lo is a network of high-capacity, protected bike lanes, many of which are designed to be clear and safe for year-round cycling." },
                    { summary: "Why 'specialized options'?", content: "This refers to proposals to add features like baby seats to the Bixi bike-share service, making it more accessible for families." }
                ]
            },
            { 
                id: 2, 
                text: "I support **banning any new bike lanes on commercial streets** and removing existing lanes that eliminate essential parking spots for businesses.",
                details: [
                    { summary: "What's the argument for this?", content: "Some candidates argue that bike lanes on commercial streets (like Ste-Catherine or Saint-Denis) hurt local businesses by removing parking, and that bike routes should be prioritized on residential streets or in parks instead." },
                    { summary: "What's the argument against this?", content: "Opponents argue that bike lanes bring more foot (and bike) traffic to businesses, reduce traffic, and are essential for creating a connected, safe transportation network." }
                ]
            },
            // --- Cleanliness (3) ---
            { 
                id: 3, 
                text: "The city must commit to **weekly garbage collection in all boroughs** year-round, even if it means raising the frequency to twice a week in the summer.",
                details: [
                    { summary: "Why is this an issue?", content: "Some boroughs have moved to bi-weekly (every two weeks) garbage collection to encourage composting and recycling. This has led to complaints about smells and overflowing bins, especially during summer." }
                ]
            },
            // --- Climate (4) ---
            { 
                id: 4, 
                text: "To fight climate change, I support implementing a **kilometre tax on vehicle use** and planting 50,000 trees to eliminate heat islands by 2032.",
                details: [
                    { summary: "What is a kilometre tax?", content: "This is a 'user-pay' system where drivers are taxed based on the distance they drive, rather than (or in addition to) a gas tax. It's proposed as a way to strongly discourage car use and fund public transit." }
                ]
            },
            // --- Cost of Living (5-6) ---
            { 
                id: 5, 
                text: "The municipal public transit discount currently offered to students should be extended to **all low-income residents** earning less than <strong>$47,500</strong>.",
                details: [
                    { summary: "What are the different proposals?", content: "Candidates have proposed different income thresholds for this discount. This question uses the highest proposed threshold ($47,500 from Transition MontrÃ©al). Projet MontrÃ©al proposed a lower threshold ($30,000)." }
                ]
            },
            { 
                id: 6, 
                text: "Residential parking permits should be capped at <strong>$50</strong> per year, and parking meters should be **free all weekend** (Friday 9 PM to Monday 9 AM).",
                details: [
                    { summary: "What's the context?", content: "This is a proposal from Action MontrÃ©al aimed at reducing the financial burden on car owners, who they feel are unfairly taxed by the current administration." }
                ]
            },
            // --- Culture (7) ---
            { 
                id: 7, 
                text: "The city should designate a **Night Mayor and Night Council** to act as a mediator for noise complaints, reducing police involvement in cultural venue issues.",
                details: [
                    { summary: "What would a 'Night Mayor' do?", content: "This person and their council would manage the city's nightlife economy, working to resolve conflicts between venues (bars, concert halls) and residents through mediation, rather than immediately involving police for noise complaints." }
                ]
            },
            // --- Democratic Reform (8) ---
            { 
                id: 8, 
                text: "Montreal's electoral system must be reformed by introducing a **preferential ballot** for mayoral races and a single transferable vote for other positions.",
                details: [
                    { summary: "What is a preferential ballot?", content: "Instead of picking just one candidate, you would rank your choices (1st, 2nd, 3rd, etc.). If no one wins 50% of the 1st-choice votes, the candidate with the fewest votes is eliminated, and their votes go to their voters' 2nd choice. This continues until one candidate has a majority." }
                ]
            },
            // --- Economy/Taxes (9) ---
            { 
                id: 9, 
                text: "I support introducing a **new municipal tax on individual residential properties valued over <strong>$3.5 million</strong>** to fund anti-gentrification and homelessness efforts.",
                details: [
                    { summary: "What kind of tax is this?", content: "This is a 'mansion tax' or 'luxury tax' proposed by Transition MontrÃ©al. It would apply only to the city's most expensive homes to create a dedicated fund for social programs." }
                ]
            },
            // --- Homelessness (10) ---
            { 
                id: 10, 
                text: "For homelessness, the city should **declare a state of emergency** to requisition hotels and vacant buildings, and ban police from intervening in large encampments.",
                details: [
                    { summary: "What does 'requisition' mean?", content: "This would involve the city taking temporary control of empty buildings (like unused hotels) to provide immediate shelter for the homeless, particularly during winter." },
                    { summary: "Why ban police?", content: "This proposal suggests that police dismantling encampments is harmful and ineffective. Instead, it advocates for sending social service teams to support people on-site." }
                ]
            },
            // --- Housing (11-12) ---
            { 
                id: 11, 
                text: "The city must **eliminate the current affordable housing bylaw** (the '20-20-20' rule) and replace it with a new system.",
                details: [
                    { summary: "What is the current bylaw?", content: "Known as the '20-20-20' bylaw, it requires new developments to include 20% social housing, 20% affordable housing, and 20% family-sized units. Many candidates (from all sides) argue it has failed and actually stalled construction." }
                ]
            },
            { 
                id: 12, 
                text: "I support a **complete moratorium (total ban)** on all short-term rentals (like Airbnb) in residential units to preserve the housing stock for families.",
                details: [
                    { summary: "How is this different from other proposals?", content: "This is the strictest position, proposed by Transition MontrÃ©al. Other candidates propose limiting short-term rentals to 90 days/year or banning only *commercial* operators, rather than a total ban." }
                ]
            },
            // --- Public Transit (13) ---
            { 
                id: 13, 
                text: "The city's top transit priority should be **Metro extensions** (Orange line to Bois-Franc, Green line to Lachine), not the construction of new tramway lines.",
                details: [
                    { summary: "What is the debate?", content: "There's a major debate over which is better: expanding the existing, high-capacity Metro system (which is very expensive) or building new, more flexible tramway lines on the surface (which is cheaper but can be slowed by traffic)." }
                ]
            },
            // --- Safety/Policing (14-15) ---
            { 
                id: 14, 
                text: "The city should redirect <strong>$25 million</strong> from the police budget (like overtime) to **prevention and new civilian services** to address non-urgent social issues.",
                details: [
                    { summary: "Is this 'defunding the police'?", content: "This proposal (from Transition MontrÃ©al) aims to re-allocate a portion of the police budgetâ€”specifically from overtimeâ€”to fund social workers, prevention programs, and civilian response teams, rather than cutting officer positions." }
                ]
            },
            { 
                id: 15, 
                text: "To ensure safety and secularism, I support a strong police crackdown on unruly protests and the requirement of a **permit for any religious event** in a public space.",
                details: [
                    { summary: "What does this mean?", content: "This proposal from Action MontrÃ©al would require any religious gathering in a public space (like a street prayer) to get a permit. It also calls for increased police enforcement at protests that are deemed 'disruptive' or 'unruly'." }
                ]
            },
            // --- Israel-Gaza (16) ---
            { 
                id: 16, 
                text: "Montreal should take a clear stance on the Israel-Gaza conflict by officially calling for an **arms embargo on Israel** and supporting **divestment from genocide**.",
                details: [
                    { summary: "Why is this a municipal issue?", content: "Some candidates (Rabouin, SauvÃ©) believe the city has a moral duty to take a stand on international human rights issues. Others (Ferrada, Thibodeau, Kacou) argue this is 'importing a foreign conflict' and is outside municipal jurisdiction." }
                ]
            },
            // --- NEW Q17 (Traffic) ---
            { 
                id: 17, 
                text: "The city should permanently **close Camillien-Houde Way to through-traffic** and transform it into a green walking and public transit path on Mount Royal.",
                details: [
                    { summary: "What's the 'Camillien-Houde' debate?", content: "This is a long-standing, heated debate. Projet MontrÃ©al (Rabouin) wants to close the road that cuts across the mountain to cars. Others (Ferrada, Thibodeau) are strongly opposed, arguing it's a vital link for drivers." }
                ]
            },
            // --- NEW Q18 (Culture) ---
            { 
                id: 18, 
                text: "The city's cultural priority should be to create **affordable housing reserved for artists** and a special fund to help local venues acquire their own spaces.",
                details: [
                    { summary: "Why 'reserved housing'?", content: "This proposal from Projet MontrÃ©al aims to keep artists from being pushed out of the city by gentrification, ensuring they can live and work affordably. The fund would help independent venues (like small theatres or music halls) buy their buildings." }
                ]
            },
            // --- NEW Q19 (Economy) ---
            { 
                id: 19, 
                text: "The city's top priority for the East End should be creating a **new university hub** and supporting clean technology and circular economy projects.",
                details: [
                    { summary: "What is the 'East End' focus?", content: "Many candidates have a plan for Montreal's East End. This specific proposal from Projet MontrÃ©al focuses on economic development through education (a new university) and the 'green' economy (clean tech)." }
                ]
            },
            // --- NEW Q20 (Public Transit) ---
            { 
                id: 20, 
                text: "The city must prioritize building new **tramway lines** as the future of public transit, rather than focusing primarily on new Metro line extensions.",
                details: [
                    { summary: "What's the tramway plan?", content: "This proposal (strongly supported by Projet MontrÃ©al) involves building three new tram lines: in the East End, the Southwest, and a 'loop' connecting CÃ´te-des-Neiges, Jean-Talon, and du Parc. This is in direct contrast to candidates who favor Metro expansion." }
                ]
            }
        ];
        
        // --- App State ---
        let currentQuestionIndex = 0;
        let userAgreementAnswers = new Array(QUESTIONS.length).fill(null); // Stores -2 to 2
        
        // --- Helper Functions ---

        /**
         * Calculates the agreement score for one question.
         * The formula is: (5 - |User Score - Candidate Score|) * Importance Multiplier
         */
        function calculateAgreement(userScore, candidateScore, points) {
            const scoreDifference = Math.abs(userScore - candidateScore);
            const rawAgreement = 5 - scoreDifference;
            return rawAgreement * points;
        }

        /**
         * Updates the total points display and enables/disables the calculate button.
         */
        function updatePointTotal() {
            const pointInputs = document.querySelectorAll('.point-input');
            let totalPoints = 0;
            pointInputs.forEach(input => {
                totalPoints += parseInt(input.value) || 0;
            });

            const display = document.getElementById('total-points-display');
            const helper = document.getElementById('points-helper');
            const calculateBtn = document.getElementById('submit-quiz-btn');

            display.textContent = `${totalPoints} / 100`;

            if (totalPoints === 100) {
                display.classList.remove('error');
                helper.textContent = "Perfect! Your total is 100. You're ready to calculate!";
                helper.style.color = 'var(--color-success)';
                calculateBtn.disabled = false;
            } else {
                display.classList.add('error');
                helper.textContent = `Whoops! Your total must be exactly 100. You are ${Math.abs(100 - totalPoints)} points ${totalPoints > 100 ? 'over' : 'under'}.`;
                helper.style.color = 'var(--color-error)';
                calculateBtn.disabled = true;
            }
        }
        
        /**
         * Shows a specific card by its ID and hides all others
         */
         function showCard(cardId) {
            document.querySelectorAll('.quiz-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById(cardId).classList.add('active');
         }

        /**
         * Updates the progress bar
         */
         function updateProgressBar(questionIndex, totalQuestions = QUESTIONS.length + 1) { // +1 for weighting card
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                const percentage = ((questionIndex + 1) / totalQuestions) * 100;
                progressBar.style.width = `${percentage}%`;
            }
         }

        // --- Main Logic ---

        /**
         * Renders all 20 question cards into the DOM (hidden)
         */
        function renderQuestionCards() {
            const container = document.getElementById('question-card-container');
            let html = '';

            QUESTIONS.forEach((q, index) => {
                // Build Accordion HTML
                let detailsHtml = '';
                if (q.details && q.details.length > 0) {
                    detailsHtml += '<div class="accordion-container">';
                    q.details.forEach(detail => {
                        detailsHtml += `
                            <details>
                                <summary>${detail.summary}</summary>
                                <div class="accordion-content">
                                    <p style="margin-top: 0.25rem; margin-bottom: 1rem;">${detail.content}</p>
                                </div>
                            </details>
                        `;
                    });
                    detailsHtml += '</div>';
                }
                
                // Build Full Question Card
                html += `
                    <div class="quiz-card" id="question-card-${index}">
                        <div class="progress-container">
                            <div id="progress-bar-${index}" class="progress-bar"></div>
                        </div>
                        <div class="card-content">
                            <div class="question-header">Question ${index + 1} of ${QUESTIONS.length}</div>
                            <div class="question-text">${q.text.replace(/<strong>/g, '<strong>')}</div>
                            
                            <div class="radio-group" id="radio-group-${index}">
                                <input type="radio" id="q${q.id}-sd" name="agreement-${q.id}" value="-2" required><label class="radio-label" for="q${q.id}-sd">Strongly Disagree</label>
                                <input type="radio" id="q${q.id}-d" name="agreement-${q.id}" value="-1"><label class="radio-label" for="q${q.id}-d">Disagree</label>
                                <input type="radio" id="q${q.id}-n" name="agreement-${q.id}" value="0"><label class="radio-label" for="q${q.id}-n">Neutral</label>
                                <input type="radio" id="q${q.id}-a" name="agreement-${q.id}" value="1"><label class="radio-label" for="q${q.id}-a">Agree</label>
                                <input type="radio" id="q${q.id}-sa" name="agreement-${q.id}" value="2"><label class="radio-label" for="q${q.id}-sa">Strongly Agree</label>
                            </div>
                            
                            ${detailsHtml}

                            <div class="navigation-buttons">
                                <button type="button" class="nav-btn secondary" id="prev-btn-${index}" ${index === 0 ? 'disabled' : ''}>Previous</button>
                                <button type="button" class="nav-btn" id="next-btn-${index}">Next</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        /**
         * Renders the list of 20 questions into the weighting card
         */
        function renderWeightingCard() {
            const listContainer = document.getElementById('weighting-list');
            let html = '';
            
            QUESTIONS.forEach((q, index) => {
                const questionShortText = q.text.split('**')[1] || q.text.split('<strong>')[1] || q.text;
                html += `
                    <div class="weighting-list-item">
                        <label for="points-${index}" class="weighting-q-text">
                            ${q.id}. <strong>${questionShortText}</strong>
                        </label>
                        <input type="number" class="point-input" id="points-${index}" name="points-${index}" value="5" min="0" max="100">
                    </div>
                `;
            });
            listContainer.innerHTML = html;
            
            // Add progress bar to weighting card
            const weightingCard = document.getElementById('weighting-card');
            weightingCard.insertAdjacentHTML('afterbegin', `
                <div class="progress-container">
                    <div id="progress-bar-weighting" class="progress-bar" style="width: ${ (QUESTIONS.length / (QUESTIONS.length + 1)) * 100 }%;"></div>
                </div>
            `);
        }
        
        /**
         * Attaches all the necessary event listeners after rendering
         */
        function attachListeners() {
            // Start button
            document.getElementById('start-btn').addEventListener('click', () => {
                showCard('question-card-0');
                updateProgressBar(0);
            });
            
            // Next/Prev buttons
            QUESTIONS.forEach((q, index) => {
                const nextBtn = document.getElementById(`next-btn-${index}`);
                const prevBtn = document.getElementById(`prev-btn-${index}`);

                nextBtn.addEventListener('click', () => {
                    // 1. Validate and save answer
                    const selected = document.querySelector(`input[name="agreement-${q.id}"]:checked`);
                    if (!selected) {
                        alert('Please select an answer to continue.');
                        return;
                    }
                    userAgreementAnswers[index] = parseInt(selected.value);
                    
                    // 2. Move to next card
                    currentQuestionIndex++;
                    if (currentQuestionIndex < QUESTIONS.length) {
                        showCard(`question-card-${currentQuestionIndex}`);
                        updateProgressBar(currentQuestionIndex);
                        // Check if this next question has a stored answer
                        if (userAgreementAnswers[currentQuestionIndex] !== null) {
                            document.querySelector(`#q${QUESTIONS[currentQuestionIndex].id}-${userAgreementAnswers[currentQuestionIndex]}`).checked = true;
                        }
                    } else {
                        // Finished last question, move to weighting card
                        showCard('weighting-card');
                        updateProgressBar(currentQuestionIndex); // This will be 20/21
                        updatePointTotal();
                    }
                });

                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        currentQuestionIndex--;
                        showCard(`question-card-${currentQuestionIndex}`);
                        updateProgressBar(currentQuestionIndex);
                    });
                }
            });
            
            // Weighting card listeners
            document.getElementById('weighting-list').addEventListener('input', (event) => {
                if (event.target.classList.contains('point-input')) {
                    // Sanitize input
                    let value = parseInt(event.target.value.replace(/[^0-9]/g, ''));
                    if (isNaN(value) || value < 0) {
                        event.target.value = 0;
                    } else if (value > 100) {
                        event.target.value = 100;
                    } else {
                        event.target.value = value;
                    }
                    updatePointTotal();
                }
            });
            
            // Submit button
            document.getElementById('submit-quiz-btn').addEventListener('click', calculateResults);
        }

        /**
         * Calculates the final results and displays them.
         */
        function calculateResults() {
            const results = {};
            const errorMsg = document.getElementById('error-message');
            errorMsg.style.display = 'none';

            for (const candidate in CANDIDATE_SCORES) {
                results[candidate] = 0;
            }

            let totalPerfectScore = 0;
            let currentTotalPoints = 0;

            for (let i = 0; i < QUESTIONS.length; i++) {
                const userScore = userAgreementAnswers[i]; // Get stored answer
                const userPointsStr = document.getElementById(`points-${i}`).value;
                
                const userPoints = parseInt(userPointsStr) || 0;
                
                currentTotalPoints += userPoints;
                totalPerfectScore += (5 * userPoints); // Max possible score for this q
                
                for (const candidate in CANDIDATE_SCORES) {
                    const candidateScore = CANDIDATE_SCORES[candidate][i];
                    const agreementScore = calculateAgreement(userScore, candidateScore, userPoints);
                    results[candidate] += agreementScore;
                }
            }
            
            if (currentTotalPoints !== 100) {
                 errorMsg.textContent = `Your total points must be exactly 100. Please adjust.`;
                 errorMsg.style.display = 'block';
                 return;
            }

            const finalResults = [];
            for (const candidate in results) {
                const score = results[candidate];
                const percentage = (totalPerfectScore === 0) ? 0 : (score / totalPerfectScore) * 100;
                finalResults.push({
                    name: candidate.replace(/ \(.*\)/, ''), 
                    party: candidate.match(/\(([^)]+)\)/)[1], 
                    percentage: parseFloat(percentage.toFixed(1))
                });
            }

            finalResults.sort((a, b) => b.percentage - a.percentage);
            renderResults(finalResults);
        }

        /**
         * Renders the final results as percentage bars.
         */
        function renderResults(results) {
            const outputDiv = document.getElementById('results-output');
            let html = '';

            results.forEach((r, index) => {
                const topMatchClass = (index === 0) ? 'top-match' : '';
                html += `
                    <div class="result-bar ${topMatchClass}">
                        <div class="result-bar-info">
                            <span class="candidate-name">${r.name} (${r.party})</span>
                            <span class="result-percent">${r.percentage}%</span>
                        </div>
                        <div class="bar-wrapper">
                            <div class="bar-fill" style="width: 0%;" data-width="${r.percentage}">
                            </div>
                        </div>
                    </div>
                `;
            });
            outputDiv.innerHTML = html;
            
            // Show the results card
            showCard('results-card');

            // Animate bars
            setTimeout(() => {
                document.querySelectorAll('.bar-fill').forEach(bar => {
                    bar.style.width = bar.getAttribute('data-width') + '%';
                });
            }, 100);

            // Scroll to top of container
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
        }


        // --- Event Listeners and Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            renderQuestionCards();
            renderWeightingCard();
            attachListeners();
        });
    </script>
</body>
</html>
