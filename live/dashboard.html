<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="https://hsnorth.github.io/embed_live/live/gazette-admin-icon-192.png">
</head>
<body>

    <header>
        <h1><a href="dashboard.html">Gazette Live</a></h1>
        <nav>
            <button id="signOutButton" class="submit-button">Sign Out</button>
        </nav>
    </header>

    <main>
        <h2>Dashboard</h2>

        <section class="create-tool-section">
            <h2>Create</h2>
            <div class="form-group">
                <label for="createToolSelect" style="margin-bottom: 8px; display: block;">Select a tool to create:</label>
                <select id="createToolSelect" class="input-field">
                    <option value="">-- Select a tool --</option>
                    <option value="liveBlog">Live Blog</option>
                    <option value="verticalProfileCards">Vertical Profile Cards</option>
                </select>
            </div>
            <div id="toolNameContainer" style="display: none;">
                <div class="form-group">
                    <input type="text" id="newToolName" class="input-field" placeholder="Enter a title">
                </div>
                <button id="startNewToolBtn" class="submit-button">Start</button>
            </div>
        </section>

        <section class="find-tools-container">
            <h2>Find tools</h2>
            <div class="filter-controls" style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <label for="filterByType">Filter by type:</label>
                <select id="filterByType" class="input-field" style="width: auto;">
                    <option value="all">All</option>
                    <option value="liveBlog">Live Blog</option>
                    <option value="verticalProfileCards">Vertical Profile Cards</option>
                </select>
            </div>
            <div class="blog-list" id="toolListContainer">
                <ul id="toolsList">
                    </ul>
                <p id="noToolsMessage" class="no-blogs-message" style="display: none;">No tools found. Create one above!</p>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 The Gazette Live. All rights reserved.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrJsFAJDU4EMficerN2TvOJlio6SYh6lk",
            authDomain: "myliveblogapp-cf9df.firebaseapp.com",
            projectId: "myliveblogapp-cf9df",
            storageBucket: "myliveblogapp-cf9df.firebasestorage.app",
            messagingSenderId: "324824649312",
            appId: "1:324824649312:web:c0750693346091d853bd05",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let isDashboardSetup = false;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                setupDashboard(user);
            } else {
                window.location.href = 'index.html';
            }
        });

        function setupDashboard(user) {
            if (isDashboardSetup) return;
            isDashboardSetup = true;

            loadAllTools();

            const createToolSelect = document.getElementById('createToolSelect');
            const toolNameContainer = document.getElementById('toolNameContainer');
            const newToolNameInput = document.getElementById('newToolName');
            const startNewToolBtn = document.getElementById('startNewToolBtn');

            createToolSelect.addEventListener('change', () => {
                const selectedTool = createToolSelect.value;
                if (selectedTool === 'liveBlog') {
                    newToolNameInput.placeholder = "Enter blog title";
                    startNewToolBtn.textContent = "Start New Blog";
                    toolNameContainer.style.display = 'block';
                } else if (selectedTool === 'verticalProfileCards') {
                    newToolNameInput.placeholder = "Enter card set title";
                    startNewToolBtn.textContent = "Create Card Set";
                    toolNameContainer.style.display = 'block';
                } else {
                    toolNameContainer.style.display = 'none';
                }
            });

            startNewToolBtn.addEventListener('click', async () => {
                const toolName = newToolNameInput.value.trim();
                const selectedTool = createToolSelect.value;

                if (!toolName) {
                    alert('Please enter a title.');
                    return;
                }

                let collectionName = '';
                let redirectPage = '';
                let idParam = '';
                let nameParam = '';

                if (selectedTool === 'liveBlog') {
                    collectionName = 'blogs';
                    redirectPage = 'create-blog.html';
                    idParam = 'blogId';
                    nameParam = 'blogName';
                } else if (selectedTool === 'verticalProfileCards') {
                    collectionName = 'verticalProfileCards';
                    redirectPage = 'create-cards.html'; // This page needs to be created
                    idParam = 'cardSetId';
                    nameParam = 'cardSetName';
                } else {
                    return; // Should not happen
                }

                try {
                    const docRef = await addDoc(collection(db, collectionName), {
                        name: toolName,
                        created: serverTimestamp(),
                        createdBy: user.uid
                    });
                    const toolId = docRef.id;
                    window.location.href = `${redirectPage}?${idParam}=${toolId}&${nameParam}=${encodeURIComponent(toolName)}`;
                } catch (e) {
                    console.error("Error adding document: ", e);
                    alert("Error creating tool. Please try again.");
                }
            });
            
            document.getElementById('filterByType').addEventListener('change', () => {
                const selectedType = document.getElementById('filterByType').value;
                const toolItems = document.querySelectorAll('#toolsList li');
                let visibleCount = 0;

                toolItems.forEach(item => {
                    if (selectedType === 'all' || item.dataset.type === selectedType) {
                        item.style.display = 'flex';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });
                document.getElementById('noToolsMessage').style.display = visibleCount > 0 ? 'none' : 'block';
            });

            document.getElementById('signOutButton').addEventListener('click', () => signOut(auth));
        }

        const loadAllTools = async () => {
            const toolsList = document.getElementById('toolsList');
            const noToolsMessage = document.getElementById('noToolsMessage');
            
            try {
                // Fetch from both collections
                const blogsQuery = query(collection(db, "blogs"), orderBy("created", "desc"));
                const cardsQuery = query(collection(db, "verticalProfileCards"), orderBy("created", "desc"));

                const [blogsSnapshot, cardsSnapshot] = await Promise.all([
                    getDocs(blogsQuery),
                    getDocs(cardsQuery)
                ]);

                let allTools = [];

                blogsSnapshot.forEach(doc => {
                    allTools.push({ id: doc.id, type: 'liveBlog', ...doc.data() });
                });

                cardsSnapshot.forEach(doc => {
                    allTools.push({ id: doc.id, type: 'verticalProfileCards', ...doc.data() });
                });

                // Sort all tools together by creation date safely
                allTools.sort((a, b) => {
                    const timeA = a.created ? a.created.toMillis() : 0;
                    const timeB = b.created ? b.created.toMillis() : 0;
                    return timeB - timeA;
                });

                if (allTools.length > 0) {
                    toolsList.innerHTML = '';
                    allTools.forEach(tool => {
                        const listItem = document.createElement('li');
                        listItem.dataset.type = tool.type;
                        const createdDate = tool.created ? tool.created.toDate().toLocaleString() : 'N/A';
                        
                        let link = '';
                        if (tool.type === 'liveBlog') {
                            link = `create-blog.html?blogId=${tool.id}&blogName=${encodeURIComponent(tool.name)}`;
                        } else if (tool.type === 'verticalProfileCards') {
                            link = `create-cards.html?cardSetId=${tool.id}&cardSetName=${encodeURIComponent(tool.name)}`;
                        }

                        listItem.innerHTML = `
                            <a href="${link}">${tool.name} <span style="font-size: 0.8em; color: #777; margin-left: 8px;">(${tool.type === 'liveBlog' ? 'Live Blog' : 'Profile Cards'})</span></a>
                            <span>Created: ${createdDate}</span>
                        `;
                        toolsList.appendChild(listItem);
                    });
                    noToolsMessage.style.display = 'none';
                } else {
                    toolsList.innerHTML = '';
                    noToolsMessage.style.display = 'block';
                    noToolsMessage.textContent = 'No tools created yet. Create one above!';
                }
            } catch (error) {
                console.error("Error fetching tools: ", error);
                noToolsMessage.textContent = "Error loading tools. Check console for details.";
                noToolsMessage.style.display = 'block';
            }
        };
    </script>
</body>
</html>
