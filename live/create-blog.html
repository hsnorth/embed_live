<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Blog Post</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .tab-button {
            background-color: #e0e7ff; /* indigo-100 */
            color: #4f46e5; /* indigo-600 */
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* rounded-full */
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .tab-button.selected {
            background-color: #4f46e5;
            color: white;
        }
        .tab-button:hover:not(.selected) {
            background-color: #c7d2fe; /* indigo-200 */
        }
        .input-field {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.75rem;
            width: 100%;
            box-sizing: border-box;
        }
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.show {
            display: block;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-8">
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-md space-y-8">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">Manage: Test Wednesday</h1>

        <!-- Blog Name and Author Info (Read-only for now) -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-2" id="blog-name-display">Loading Blog Name...</h2>
            <p class="text-gray-600" id="author-info-display">Author: Loading...</p>
        </div>

        <!-- Assign to Tabs Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Assign to Tabs</h2>
            <div id="tabs-container" class="flex flex-wrap gap-2">
                <!-- Tabs will be loaded here by JavaScript -->
            </div>
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="live-reporting-checkbox" class="form-checkbox h-5 w-5 text-indigo-600 rounded">
                <label for="live-reporting-checkbox" class="text-gray-700">Live Reporting</label>
            </div>
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="whats-on-today-checkbox" class="form-checkbox h-5 w-5 text-indigo-600 rounded">
                <label for="whats-on-today-checkbox" class="text-gray-700">What's on today</label>
            </div>
        </div>

        <!-- Image/Video Upload Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Image or Video:</h2>
            <input type="file" id="media-upload" accept="image/*,video/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            <div id="media-preview-container" class="mt-4 hidden">
                <img id="media-preview-image" src="#" alt="Media Preview" class="max-w-full h-auto rounded-lg shadow-sm hidden">
                <video id="media-preview-video" controls class="max-w-full h-auto rounded-lg shadow-sm hidden"></video>
                <button id="remove-media-button" class="mt-2 btn-danger">Remove Media</button>
            </div>
        </div>

        <!-- Post Creation Form -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Posting...</h2>
            <input type="text" id="post-subtitle" placeholder="Subtitle" class="input-field">
            <textarea id="post-content" placeholder="Content" class="input-field"></textarea>
            <input type="text" id="reporting-from" placeholder="Reporting from (e.g., Montreal, Quebec)" class="input-field">
            <button id="post-button" class="btn-primary w-full">Post</button>
            <button id="update-post-button" class="btn-primary w-full hidden">Update Post</button>
            <button id="cancel-edit-button" class="btn-danger w-full mt-2 hidden">Cancel Edit</button>
        </div>

        <!-- Manage Custom Tabs Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Manage Custom Tabs</h2>
            <div class="flex space-x-2">
                <input type="text" id="new-tab-name" placeholder="New Tab Name" class="input-field flex-grow">
                <button id="add-tab-button" class="btn-primary">Add Tab</button>
            </div>
            <div id="custom-tabs-list" class="space-y-2">
                <!-- Custom tabs will be listed here by JavaScript -->
            </div>
        </div>

        <!-- Embed Code Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Embed This Live Blog</h2>
            <p class="text-gray-600">Copy the code below and paste it into your website's HTML where you want the live blog to appear.</p>
            <div class="relative">
                <textarea id="embed-code-textarea" class="input-field text-sm bg-gray-50 font-mono" rows="4" readonly>&lt;iframe src="https://myliveblogapp-cf9df.web.app/embed-posts.html?blogId=YOUR_BLOG_ID" width="100%" height="600px" frameborder="0"&gt;&lt;/iframe&gt;</textarea>
                <button id="copy-embed-code-button" class="absolute top-2 right-2 btn-primary px-3 py-1 text-sm">Copy Code</button>
            </div>
        </div>

        <!-- Live Blog Posts Section -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Live Blog Posts</h2>
            <div id="posts-container" class="space-y-6">
                <p id="loading-posts-message" class="text-gray-500 text-center">Loading posts...</p>
                <p id="no-posts-message" class="text-gray-500 text-center hidden">No posts for this blog. Please try again later.</p>
                <!-- Posts will be loaded here by JavaScript -->
            </div>
        </div>
    </div>

    <div id="message-box" class="message-box"></div>

    <!-- Firebase SDK Imports (already present in your setup) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, getDoc, serverTimestamp, deleteDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        // Your firebaseConfig object goes here
        const firebaseConfig = {
            apiKey: "", // Left blank as per instructions, Canvas will provide
            authDomain: "myliveblogapp-cf9df.firebaseapp.com",
            projectId: "myliveblogapp-cf9df",
            storageBucket: "myliveblogapp-cf9df.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID", // Replace with your actual sender ID if needed
            appId: "YOUR_APP_ID", // Replace with your actual app ID if needed
            measurementId: "YOUR_MEASUREMENT_ID" // Optional
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // Global variables for Firebase instances and user ID
        let currentUserId = null;
        let currentUser = null;
        let currentBlogId = null; // Will be set from URL or new blog creation
        let currentBlogData = null; // To store blog name and custom tabs

        // --- Utility Functions ---
        function showMessageBox(message, type = 'success') {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = 'message-box show'; // Reset classes and show
            if (type === 'error') {
                msgBox.style.backgroundColor = '#dc2626'; // Red for error
            } else {
                msgBox.style.backgroundColor = '#4CAF50'; // Green for success
            }

            setTimeout(() => {
                msgBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        // Function to parse URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // --- DOM Elements ---
        const blogNameDisplay = document.getElementById('blog-name-display');
        const authorInfoDisplay = document.getElementById('author-info-display');
        const tabsContainer = document.getElementById('tabs-container');
        const liveReportingCheckbox = document.getElementById('live-reporting-checkbox');
        const whatsOnTodayCheckbox = document.getElementById('whats-on-today-checkbox');
        const mediaUploadInput = document.getElementById('media-upload');
        const mediaPreviewContainer = document.getElementById('media-preview-container');
        const mediaPreviewImage = document.getElementById('media-preview-image');
        const mediaPreviewVideo = document.getElementById('media-preview-video');
        const removeMediaButton = document.getElementById('remove-media-button');
        const postSubtitleInput = document.getElementById('post-subtitle');
        const postContentInput = document.getElementById('post-content');
        const reportingFromInput = document.getElementById('reporting-from');
        const postButton = document.getElementById('post-button');
        const updatePostButton = document.getElementById('update-post-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const newTabNameInput = document.getElementById('new-tab-name');
        const addTabButton = document.getElementById('add-tab-button');
        const customTabsList = document.getElementById('custom-tabs-list');
        const embedCodeTextarea = document.getElementById('embed-code-textarea');
        const copyEmbedCodeButton = document.getElementById('copy-embed-code-button');
        const postsContainer = document.getElementById('posts-container');
        const loadingPostsMessage = document.getElementById('loading-posts-message');
        const noPostsMessage = document.getElementById('no-posts-message');

        let currentMediaFile = null;
        let currentMediaType = null;
        let editingPostId = null;

        // --- Firebase Auth & User Management ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                // Fetch or create user profile
                const userDocRef = doc(db, 'users', currentUserId);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    currentUser = userDocSnap.data();
                    // Update UI with user info if needed
                } else {
                    // Create a new user profile if it doesn't exist
                    currentUser = {
                        name: user.displayName || `User-${user.uid.substring(0, 6)}`,
                        email: user.email || '',
                        avatarUrl: user.photoURL || 'https://placehold.co/40x40/cccccc/ffffff?text=U'
                    };
                    await setDoc(userDocRef, currentUser);
                }

                // Initialize blog logic after user is authenticated
                initializeBlogManagement();

            } else {
                currentUserId = null;
                currentUser = null;
                // Redirect to login or show message if not authenticated
                showMessageBox("Please log in to manage blogs.", "error");
                // Optionally redirect to index.html or login page
                window.location.href = 'index.html';
            }
        });

        // --- Blog Management Logic ---
        async function initializeBlogManagement() {
            currentBlogId = getUrlParameter('blogId');

            if (currentBlogId) {
                // Editing an existing blog
                await loadBlogDetails(currentBlogId);
                setupRealtimePostListener(currentBlogId);
            } else {
                // No blogId in URL, redirect to dashboard or create new blog flow
                showMessageBox("No blog ID specified. Redirecting to dashboard.", "error");
                window.location.href = 'dashboard.html';
            }
        }

        async function loadBlogDetails(blogId) {
            try {
                const blogDocRef = doc(db, 'blogs', blogId);
                const blogDocSnap = await getDoc(blogDocRef);

                if (blogDocSnap.exists()) {
                    currentBlogData = { id: blogDocSnap.id, ...blogDocSnap.data() };
                    blogNameDisplay.textContent = currentBlogData.name;
                    authorInfoDisplay.textContent = `Author: ${currentBlogData.authorName || 'N/A'}`;
                    updateEmbedCode(); // Update embed code with the actual blog ID
                    renderCustomTabs(currentBlogData.customTabs || []);
                } else {
                    showMessageBox("Blog not found!", "error");
                    blogNameDisplay.textContent = "Blog Not Found";
                    authorInfoDisplay.textContent = "";
                }
            } catch (error) {
                console.error("Error loading blog details:", error);
                showMessageBox("Error loading blog details.", "error");
            }
        }

        function updateEmbedCode() {
            if (currentBlogId) {
                const embedUrl = `https://myliveblogapp-cf9df.web.app/embed-posts.html?blogId=${currentBlogId}`;
                embedCodeTextarea.value = `<iframe src="${embedUrl}" width="100%" height="600px" frameborder="0"></iframe>`;
            }
        }

        // --- Custom Tabs Management ---
        function renderCustomTabs(tabs) {
            tabsContainer.innerHTML = '';
            customTabsList.innerHTML = ''; // Clear existing list
            tabs.forEach(tab => {
                // For assign to tabs section
                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button';
                tabButton.textContent = tab;
                tabButton.dataset.tabName = tab;
                tabButton.addEventListener('click', () => {
                    tabButton.classList.toggle('selected');
                });
                tabsContainer.appendChild(tabButton);

                // For manage custom tabs list
                const tabListItem = document.createElement('div');
                tabListItem.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                tabListItem.innerHTML = `
                    <span class="text-gray-700">${tab}</span>
                    <button class="btn-danger delete-custom-tab" data-tab-name="${tab}">Delete</button>
                `;
                customTabsList.appendChild(tabListItem);
            });

            // Attach event listeners to delete buttons
            document.querySelectorAll('.delete-custom-tab').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const tabToDelete = event.target.dataset.tabName;
                    if (confirm(`Are you sure you want to delete the tab "${tabToDelete}"?`)) {
                        await deleteCustomTab(tabToDelete);
                    }
                });
            });
        }

        async function addCustomTab() {
            const newTabName = newTabNameInput.value.trim();
            if (!newTabName) {
                showMessageBox("Tab name cannot be empty!", "error");
                return;
            }

            if (currentBlogData.customTabs.includes(newTabName)) {
                showMessageBox("Tab already exists!", "error");
                return;
            }

            try {
                const blogDocRef = doc(db, 'blogs', currentBlogId);
                const updatedTabs = [...currentBlogData.customTabs, newTabName];
                await updateDoc(blogDocRef, { customTabs: updatedTabs });
                currentBlogData.customTabs = updatedTabs; // Update local data
                renderCustomTabs(updatedTabs);
                newTabNameInput.value = '';
                showMessageBox("Tab added successfully!");
            } catch (error) {
                console.error("Error adding custom tab:", error);
                showMessageBox("Failed to add tab.", "error");
            }
        }

        async function deleteCustomTab(tabName) {
            try {
                const blogDocRef = doc(db, 'blogs', currentBlogId);
                const updatedTabs = currentBlogData.customTabs.filter(tab => tab !== tabName);
                await updateDoc(blogDocRef, { customTabs: updatedTabs });
                currentBlogData.customTabs = updatedTabs; // Update local data
                renderCustomTabs(updatedTabs);
                showMessageBox("Tab deleted successfully!");
            } catch (error) {
                console.error("Error deleting custom tab:", error);
                showMessageBox("Failed to delete tab.", "error");
            }
        }

        // --- Media Upload & Preview ---
        mediaUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                currentMediaFile = file;
                const fileType = file.type.split('/')[0]; // "image" or "video"
                currentMediaType = fileType;

                const reader = new FileReader();
                reader.onload = (e) => {
                    mediaPreviewContainer.classList.remove('hidden');
                    if (fileType === 'image') {
                        mediaPreviewImage.src = e.target.result;
                        mediaPreviewImage.classList.remove('hidden');
                        mediaPreviewVideo.classList.add('hidden');
                    } else if (fileType === 'video') {
                        mediaPreviewVideo.src = e.target.result;
                        mediaPreviewVideo.classList.remove('hidden');
                        mediaPreviewImage.classList.add('hidden');
                    }
                };
                reader.readAsDataURL(file);
            } else {
                currentMediaFile = null;
                currentMediaType = null;
                mediaPreviewContainer.classList.add('hidden');
                mediaPreviewImage.classList.add('hidden');
                mediaPreviewVideo.classList.add('hidden');
                mediaPreviewImage.src = '';
                mediaPreviewVideo.src = '';
            }
        });

        removeMediaButton.addEventListener('click', () => {
            mediaUploadInput.value = ''; // Clear the file input
            currentMediaFile = null;
            currentMediaType = null;
            mediaPreviewContainer.classList.add('hidden');
            mediaPreviewImage.classList.add('hidden');
            mediaPreviewVideo.classList.add('hidden');
            mediaPreviewImage.src = '';
            mediaPreviewVideo.src = '';
        });

        // --- Post Creation/Update ---
        async function uploadMedia(file) {
            if (!file) return null;

            const storageRef = ref(storage, `blog_media/${currentBlogId}/${Date.now()}_${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Optional: Handle progress
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    },
                    (error) => {
                        console.error("Media upload failed:", error);
                        showMessageBox("Media upload failed!", "error");
                        reject(error);
                    },
                    async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        resolve(downloadURL);
                    }
                );
            });
        }

        async function createOrUpdatePost() {
            if (!currentUserId || !currentUser || !currentBlogId) {
                showMessageBox("Authentication or blog details missing. Please refresh.", "error");
                return;
            }

            const subtitle = postSubtitleInput.value.trim();
            const content = postContentInput.value.trim();
            const reportingFromValue = reportingFromInput.value.trim();

            if (!subtitle && !content && !currentMediaFile) {
                showMessageBox("Post cannot be empty!", "error");
                return;
            }

            postButton.disabled = true;
            updatePostButton.disabled = true;
            showMessageBox("Posting...", "success"); // Temporary message

            try {
                let mediaUrl = null;
                if (currentMediaFile) {
                    mediaUrl = await uploadMedia(currentMediaFile);
                } else if (editingPostId) {
                    // If editing and no new file, retain existing media URL
                    const postDocSnap = await getDoc(doc(db, 'posts', editingPostId));
                    if (postDocSnap.exists()) {
                        mediaUrl = postDocSnap.data().mediaUrl || null;
                    }
                }

                const assignedTabs = Array.from(tabsContainer.children)
                    .filter(button => button.classList.contains('selected'))
                    .map(button => button.dataset.tabName);

                if (liveReportingCheckbox.checked) {
                    if (!assignedTabs.includes('Live Reporting')) {
                        assignedTabs.push('Live Reporting');
                    }
                } else {
                    const index = assignedTabs.indexOf('Live Reporting');
                    if (index > -1) {
                        assignedTabs.splice(index, 1);
                    }
                }

                if (whatsOnTodayCheckbox.checked) {
                    if (!assignedTabs.includes('What\'s on today')) {
                        assignedTabs.push('What\'s on today');
                    }
                } else {
                    const index = assignedTabs.indexOf('What\'s on today');
                    if (index > -1) {
                        assignedTabs.splice(index, 1);
                    }
                }

                const postData = {
                    blogId: currentBlogId,
                    authorId: currentUserId,
                    authorName: currentUser.name,
                    authorAvatar: currentUser.avatarUrl,
                    subtitle: subtitle,
                    content: content,
                    reportingFrom: reportingFromValue,
                    mediaUrl: mediaUrl,
                    mediaType: currentMediaFile ? currentMediaType : (editingPostId ? (await getDoc(doc(db, 'posts', editingPostId))).data().mediaType : null),
                    assignedTabs: assignedTabs,
                    timestamp: serverTimestamp()
                };

                if (editingPostId) {
                    // Update existing post
                    const postDocRef = doc(db, 'posts', editingPostId);
                    await updateDoc(postDocRef, postData);
                    showMessageBox("Post updated successfully!");
                } else {
                    // Create new post
                    await addDoc(collection(db, 'posts'), postData);
                    showMessageBox("Post created successfully!");
                }

                // Clear form after successful post/update
                clearPostForm();

            } catch (error) {
                console.error("Error creating/updating post:", error);
                showMessageBox("Failed to create/update post.", "error");
            } finally {
                postButton.disabled = false;
                updatePostButton.disabled = false;
            }
        }

        function clearPostForm() {
            postSubtitleInput.value = '';
            postContentInput.value = '';
            reportingFromInput.value = '';
            mediaUploadInput.value = '';
            currentMediaFile = null;
            currentMediaType = null;
            mediaPreviewContainer.classList.add('hidden');
            mediaPreviewImage.classList.add('hidden');
            mediaPreviewVideo.classList.add('hidden');
            mediaPreviewImage.src = '';
            mediaPreviewVideo.src = '';

            // Deselect all tabs
            Array.from(tabsContainer.children).forEach(button => {
                button.classList.remove('selected');
            });
            liveReportingCheckbox.checked = false;
            whatsOnTodayCheckbox.checked = false;

            editingPostId = null;
            postButton.classList.remove('hidden');
            updatePostButton.classList.add('hidden');
            cancelEditButton.classList.add('hidden');
        }

        // --- Real-time Post Listener ---
        let unsubscribeFromPosts = null;

        function setupRealtimePostListener(blogId) {
            if (unsubscribeFromPosts) {
                unsubscribeFromPosts(); // Unsubscribe from previous listener if exists
            }

            const postsCollectionRef = collection(db, 'posts');
            const q = query(
                postsCollectionRef,
                where('blogId', '==', blogId),
                orderBy('timestamp', 'desc')
            );

            unsubscribeFromPosts = onSnapshot(q, (snapshot) => {
                const updatedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPosts(updatedPosts);
            }, (error) => {
                console.error("Error listening to posts:", error);
                showMessageBox("Error loading live posts.", "error");
                loadingPostsMessage.classList.add('hidden');
                noPostsMessage.classList.remove('hidden');
            });
        }

        function renderPosts(posts) {
            postsContainer.innerHTML = ''; // Clear existing posts
            loadingPostsMessage.classList.add('hidden');

            if (posts.length === 0) {
                noPostsMessage.classList.remove('hidden');
                return;
            } else {
                noPostsMessage.classList.add('hidden');
            }

            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'card p-4 space-y-3';
                postElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${post.authorAvatar || 'https://placehold.co/40x40/cccccc/ffffff?text=U'}" alt="${post.authorName}'s avatar" class="w-10 h-10 rounded-full">
                        <div>
                            <p class="font-semibold text-gray-800">${post.authorName}</p>
                            <p class="text-sm text-gray-500">${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                        </div>
                    </div>
                    ${post.subtitle ? `<h3 class="text-lg font-semibold text-gray-800">${post.subtitle}</h3>` : ''}
                    ${post.content ? `<p class="text-gray-700">${post.content}</p>` : ''}
                    ${post.mediaUrl ? `
                        <div class="media-container">
                            ${post.mediaType === 'image' ? `<img src="${post.mediaUrl}" alt="Post media" class="max-w-full h-auto rounded-lg">` : ''}
                            ${post.mediaType === 'video' ? `<video controls src="${post.mediaUrl}" class="max-w-full h-auto rounded-lg"></video>` : ''}
                        </div>
                    ` : ''}
                    ${post.reportingFrom ? `<p class="text-sm text-gray-600">Reporting from: ${post.reportingFrom}</p>` : ''}
                    <div class="flex flex-wrap gap-2">
                        ${(post.assignedTabs || []).map(tab => `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${tab}</span>`).join('')}
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button class="btn-primary edit-post-btn" data-post-id="${post.id}">Edit</button>
                        <button class="btn-danger delete-post-btn" data-post-id="${post.id}" data-media-url="${post.mediaUrl || ''}">Delete</button>
                    </div>
                `;
                postsContainer.appendChild(postElement);
            });

            // Attach event listeners for edit and delete
            document.querySelectorAll('.edit-post-btn').forEach(button => {
                button.addEventListener('click', (event) => editPost(event.target.dataset.postId));
            });
            document.querySelectorAll('.delete-post-btn').forEach(button => {
                button.addEventListener('click', (event) => deletePost(event.target.dataset.postId, event.target.dataset.mediaUrl));
            });
        }

        async function editPost(postId) {
            try {
                const postDocRef = doc(db, 'posts', postId);
                const postDocSnap = await getDoc(postDocRef);

                if (postDocSnap.exists()) {
                    const postData = postDocSnap.data();
                    editingPostId = postId;

                    postSubtitleInput.value = postData.subtitle || '';
                    postContentInput.value = postData.content || '';
                    reportingFromInput.value = postData.reportingFrom || '';

                    // Handle media preview for editing
                    if (postData.mediaUrl) {
                        mediaPreviewContainer.classList.remove('hidden');
                        if (postData.mediaType === 'image') {
                            mediaPreviewImage.src = postData.mediaUrl;
                            mediaPreviewImage.classList.remove('hidden');
                            mediaPreviewVideo.classList.add('hidden');
                        } else if (postData.mediaType === 'video') {
                            mediaPreviewVideo.src = postData.mediaUrl;
                            mediaPreviewVideo.classList.remove('hidden');
                            mediaPreviewImage.classList.add('hidden');
                        }
                    } else {
                        mediaPreviewContainer.classList.add('hidden');
                        mediaPreviewImage.classList.add('hidden');
                        mediaPreviewVideo.classList.add('hidden');
                    }

                    // Select assigned tabs
                    Array.from(tabsContainer.children).forEach(button => {
                        if (postData.assignedTabs && postData.assignedTabs.includes(button.dataset.tabName)) {
                            button.classList.add('selected');
                        } else {
                            button.classList.remove('selected');
                        }
                    });
                    liveReportingCheckbox.checked = postData.assignedTabs && postData.assignedTabs.includes('Live Reporting');
                    whatsOnTodayCheckbox.checked = postData.assignedTabs && postData.assignedTabs.includes('What\'s on today');

                    postButton.classList.add('hidden');
                    updatePostButton.classList.remove('hidden');
                    cancelEditButton.classList.remove('hidden');

                    // Scroll to top of form
                    window.scrollTo({ top: 0, behavior: 'smooth' });

                } else {
                    showMessageBox("Post not found for editing!", "error");
                }
            } catch (error) {
                console.error("Error editing post:", error);
                showMessageBox("Failed to load post for editing.", "error");
            }
        }

        async function deletePost(postId, mediaUrl) {
            if (confirm("Are you sure you want to delete this post?")) {
                try {
                    // Delete media from storage if it exists
                    if (mediaUrl) {
                        const mediaRef = ref(storage, mediaUrl);
                        await deleteObject(mediaRef).catch(e => console.warn("Could not delete media from storage:", e.message));
                    }

                    // Delete post document from Firestore
                    await deleteDoc(doc(db, 'posts', postId));
                    showMessageBox("Post deleted successfully!");
                } catch (error) {
                    console.error("Error deleting post:", error);
                    showMessageBox("Failed to delete post.", "error");
                }
            }
        }

        // --- Event Listeners ---
        // Wrap all DOM-dependent event listeners inside DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // Check if elements exist before attaching listeners
            if (postButton) postButton.addEventListener('click', createOrUpdatePost);
            if (updatePostButton) updatePostButton.addEventListener('click', createOrUpdatePost);
            if (cancelEditButton) cancelEditButton.addEventListener('click', clearPostForm);
            if (addTabButton) addTabButton.addEventListener('click', addCustomTab);
            if (copyEmbedCodeButton) {
                copyEmbedCodeButton.addEventListener('click', () => {
                    embedCodeTextarea.select();
                    document.execCommand('copy');
                    showMessageBox("Embed code copied!");
                });
            }
        });
    </script>
</body>
</html>
