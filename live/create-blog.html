<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="blogPageTitle">Create New Live Blog</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Embed-specific styles (from previous iterations) - KEEP these as they are for the embed code generator part */
        .embed-section {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 30px;
        }
        .embed-section h3 {
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .embed-section textarea {
            width: calc(100% - 22px);
            height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
            margin-bottom: 10px;
        }
        .embed-section button {
            background-color: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        .embed-section button:hover {
            background-color: #218838;
        }
        .copy-message {
            margin-top: 10px;
            color: green;
            font-size: 0.9em;
        }
        /* Loading message for this page */
        .loading-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #555;
        }
        /* Main content hidden until loaded/authenticated (good practice) */
        #mainContent {
            display: none; 
        }
    </style>
</head>
<body>
    <header>
        <h1 id="blogHeaderTitle">My Live Blog</h1>
        <nav>
            <a href="dashboard.html">Dashboard</a>
            <a href="view-blogs.html">Previous Blogs</a>
            <a href="#" id="signOutButtonHeader">Sign Out</a>
        </nav>
    </header>

    <div id="loadingContainer" class="loading-message">
        Loading blog... Please wait.
    </div>

    <main id="mainContent">
        <section class="live-blog-posts">
            <h2>Live Updates</h2>

            <div class="new-post-form">
                <h3>Create a New Post</h3>
                <form id="postForm">
                    <div class="form-group">
                        <label for="authorNameInput">Author Name:</label>
                        <input type="text" id="authorNameInput" class="input-field" placeholder="Your Name" readonly>
                    </div>
                    <div class="form-group">
                        <label for="reportingFromInput">Reporting From:</label>
                        <input type="text" id="reportingFromInput" class="input-field" placeholder="Reporting From" value="Montreal, Quebec, Canada">
                    </div>
                    <div class="form-group">
                        <label for="postContent">Post Content:</label>
                        <textarea id="postContent" class="textarea-field" placeholder="What's happening?" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="postMedia">Add Media:</label>
                        <input type="file" id="postMedia" accept="image/*,video/*">
                    </div>
                    <button type="submit" class="submit-button">Post Update</button>
                </form>
            </div>

            <div id="postsContainer">
                </div>
            <div id="paginationControls"></div>
        </section>

        <section class="embed-section">
            <h3>Embed This Live Blog</h3>
            <p>Copy the code below to embed this blog's posts on another website.</p>
            <textarea id="embedCode" rows="6" readonly></textarea>
            <button id="copyEmbedCode">Copy Code</button>
            <span id="copyMessage" class="copy-message" style="display: none;">Copied!</span>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Live Blog</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, getDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";


        const firebaseConfig = {
            apiKey: "AIzaSyDrJsFAJDU4EMficerN2TvOJlio6SYh6lk",
            authDomain: "myliveblogapp-cf9df.firebaseapp.com",
            projectId: "myliveblogapp-cf9df",
            storageBucket: "myliveblogapp-cf9df.firebasestorage.app",
            messagingSenderId: "324824649312",
            appId: "1:324824649312:web:c0750693346091d853bd05",
            measurementId: "G-EZN90844XF"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app); // Initialize storage


        // Expose to window if needed by script.js, or better, pass as arguments
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.getDocs = getDocs;
        window.serverTimestamp = serverTimestamp;
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getDoc = getDoc;
        window.doc = doc;
        window.signOut = signOut;
        window.storage = storage; // Expose storage
        window.deleteDoc = deleteDoc; // Expose deleteDoc


        // Sign out logic (already there)
        document.getElementById('signOutButtonHeader').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Could not sign out. Please try again.");
            }
        });

        // Embed code generation logic (already there)
        const embedCodeTextarea = document.getElementById('embedCode');
        const copyEmbedCodeButton = document.getElementById('copyEmbedCode');
        const copyMessage = document.getElementById('copyMessage');

        const urlParams = new URLSearchParams(window.location.search);
        const currentBlogId = urlParams.get('blogId');

        if (currentBlogId && embedCodeTextarea) {
            // Construct the URL for the embeddable page, respecting your repo structure
            const embedUrl = `${window.location.origin}/embed_live/live/embed-posts.html?blogId=${currentBlogId}`;
            // The height of the iframe in the embed code is a fixed starting point.
            // The parent page's JS (Section 3) will then make it dynamic.
            const iframeCode = `<iframe src="${embedUrl}" width="100%" height="800px" frameborder="0" scrolling="no" style="border: none; overflow: hidden;" id="liveBlogEmbed-${currentBlogId}"></iframe>`;
            embedCodeTextarea.value = iframeCode;

            copyEmbedCodeButton.addEventListener('click', () => {
                embedCodeTextarea.select();
                document.execCommand('copy');
                copyMessage.style.display = 'inline';
                setTimeout(() => {
                    copyMessage.style.display = 'none';
                }, 2000);
            });

            // This message listener in create-blog.html is likely for live updates of the *preview* iframe
            // if you have one on this page. For the public embed, the listener is on the parent page.
            window.addEventListener('message', (event) => {
                if (event.origin === window.location.origin && event.data.type === 'iframeHeight') {
                    // This listener is mostly for if you embed the 'embed-posts.html' *within* create-blog.html
                    // as a preview. If not, this block can be removed or ignored.
                    const iframe = document.getElementById(`liveBlogEmbed-${currentBlogId}`);
                    if (iframe) {
                        iframe.style.height = (event.data.height + 20) + 'px';
                    }
                }
            });

        } else if (embedCodeTextarea) {
            embedCodeTextarea.value = "Please create or select a blog to generate embed code.";
            copyEmbedCodeButton.disabled = true;
        }

        // --- Post Creation Logic (formerly in script.js, now here or referenced) ---
        const postForm = document.getElementById('postForm');
        const authorNameInput = document.getElementById('authorNameInput');
        const reportingFromInput = document.getElementById('reportingFromInput');
        const postContentInput = document.getElementById('postContent');
        const postMediaInput = document.getElementById('postMedia');
        const postsContainer = document.getElementById('postsContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const mainContent = document.getElementById('mainContent');

        let currentUser = null; // Store current logged-in user info
        let authorAvatarUrl = ''; // Store user's avatar URL

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authorNameInput.value = user.displayName || user.email; // Prefill author name

                // Fetch user's custom avatar from 'users' collection
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    if (userData.avatarUrl) {
                        authorAvatarUrl = userData.avatarUrl;
                        console.log("User avatar URL:", authorAvatarUrl);
                    }
                }

                loadingContainer.style.display = 'none';
                mainContent.style.display = 'block';
                loadPostsForAdmin(); // Load posts in admin view
            } else {
                window.location.href = 'index.html'; // Redirect to login
            }
        });

        // Post submission handler
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                alert("You must be logged in to post.");
                return;
            }

            const content = postContentInput.value.trim();
            const reportingFrom = reportingFromInput.value.trim();
            const mediaFile = postMediaInput.files[0];

            if (!content && !mediaFile) {
                alert("Please enter some content or select a media file.");
                return;
            }

            let mediaUrl = '';
            let mediaType = '';

            // Upload media if present
            if (mediaFile) {
                const storageRef = ref(storage, `post_media/${currentBlogId}/${Date.now()}-${mediaFile.name}`);
                const uploadTask = uploadBytesResumable(storageRef, mediaFile);

                try {
                    // Show upload progress (optional)
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log('Upload is ' + progress + '% done');
                            // You can update a progress bar here
                        },
                        (error) => {
                            console.error("Media upload failed:", error);
                            alert("Failed to upload media. Please try again.");
                            return; // Stop post creation
                        }
                    );
                    await uploadTask;
                    mediaUrl = await getDownloadURL(storageRef);
                    mediaType = mediaFile.type;
                    console.log("Media uploaded:", mediaUrl);
                } catch (error) {
                    console.error("Error during media upload or getting URL:", error);
                    alert("Failed to process media. Please try again.");
                    return;
                }
            }

            try {
                const postsCollectionRef = collection(db, 'posts'); // Targeting top-level 'posts'
                await addDoc(postsCollectionRef, {
                    blogId: currentBlogId, // Link post to current blog
                    authorId: currentUser.uid,
                    authorName: authorNameInput.value,
                    authorAvatar: authorAvatarUrl, // Use the fetched avatar URL
                    content: content,
                    reportingFrom: reportingFrom,
                    mediaUrl: mediaUrl,
                    mediaType: mediaType,
                    timestamp: serverTimestamp()
                });

                postContentInput.value = '';
                reportingFromInput.value = 'Montreal, Quebec, Canada'; // Reset to default
                postMediaInput.value = ''; // Clear file input
                alert("Post added successfully!");
                adminAllPostsCached = []; // Clear cache to force a re-fetch
                loadPostsForAdmin(); // Reload posts to show new one
                if (window.parent && window.parent.document.getElementById(`liveBlogEmbed-${currentBlogId}`)) {
                    // If you have a live preview iframe on this page, force it to refresh
                    // by sending a message or reloading its content if necessary.
                    // A simple flag could work:
                    window.parent.postMessage({ type: 'refreshEmbed', blogId: currentBlogId }, window.location.origin);
                }

            } catch (error) {
                console.error("Error adding post:", error);
                alert("Failed to add post. Please try again.");
            }
        });

        // --- Functions for Admin View Post Rendering (similar to embed, but in admin context) ---

        // Pagination variables for Admin view
        let adminCurrentPage = 0;
        const adminPostsPerPage = 5; 
        let adminAllPostsCached = []; 

        // Admin-specific render posts function
        const renderAdminPosts = (posts, containerId) => {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Admin container with ID "${containerId}" not found.`);
                return;
            }
            container.innerHTML = ''; // Clear existing posts

            if (posts.length === 0) {
                container.innerHTML = '<p class="no-posts-message">No posts yet. Add your first update above!</p>';
                return;
            }

            posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'post-card'; // Re-use the post-card style
                postCard.dataset.postId = post.id; 

                let mediaHtml = '';
                if (post.mediaUrl) {
                    if (post.mediaType && post.mediaType.startsWith('image')) {
                        mediaHtml = `<img src="${post.mediaUrl}" alt="Post Image" class="post-media">`;
                    } else if (post.mediaType && post.mediaType.startsWith('video')) {
                        mediaHtml = `<video controls src="${post.mediaUrl}" class="post-media"></video>`;
                    }
                }

                const avatarUrl = post.authorAvatar || 'https://via.placeholder.com/50?text=👤'; 

                postCard.innerHTML = `
                    <div class="author-avatar">
                        <img src="${avatarUrl}" alt="Author Avatar" class="author-avatar-img">
                    </div>
                    <div class="post-content-area">
                        <div class="post-meta">
                            <strong>${post.authorName || 'Anonymous'}</strong> 
                            <span class="time-ago">${timeAgo(post.timestamp)}</span>
                            ${post.reportingFrom ? `<span class="reporting-from">Reporting from ${post.reportingFrom}</span>` : ''}
                        </div>
                        <p class="post-text">${post.content}</p>
                        ${mediaHtml}
                        <div class="post-actions">
                            <button class="delete-post-button" data-post-id="${post.id}"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                    </div>
                `;
                container.appendChild(postCard);
            });

            // Add event listeners for delete buttons
            container.querySelectorAll('.delete-post-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const postIdToDelete = e.currentTarget.dataset.postId;
                    if (confirm('Are you sure you want to delete this post?')) {
                        try {
                            const postDocRef = doc(db, 'posts', postIdToDelete);
                            await deleteDoc(postDocRef); 
                            alert('Post deleted successfully!');
                            adminAllPostsCached = []; // Clear cache
                            loadPostsForAdmin(); // Reload posts
                        } catch (error) {
                            console.error('Error deleting post:', error);
                            alert('Failed to delete post.');
                        }
                    }
                });
            });
        };

        // Function to load and display posts for admin view
        const loadPostsForAdmin = async () => {
            if (!currentBlogId) {
                postsContainer.innerHTML = '<p class="error-message">Error: No Blog ID. Please go to Dashboard to select or create a blog.</p>';
                paginationControls.innerHTML = '';
                return;
            }

            try {
                if (adminAllPostsCached.length === 0) {
                    const postsCollectionRef = collection(db, 'posts');
                    const q = query(
                        postsCollectionRef,
                        where('blogId', '==', currentBlogId),
                        orderBy('timestamp', 'desc')
                    );
                    const querySnapshot = await getDocs(q);
                    adminAllPostsCached = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Admin Fetched posts:", adminAllPostsCached);
                }

                const startIndex = adminCurrentPage * adminPostsPerPage;
                const endIndex = startIndex + adminPostsPerPage;
                const postsToShow = adminAllPostsCached.slice(startIndex, endIndex);

                renderAdminPosts(postsToShow, 'postsContainer');
                updateAdminPaginationControls(adminAllPostsCached.length);

            } catch (error) {
                console.error("Error loading admin posts:", error);
                postsContainer.innerHTML = '<p class="error-message">Error loading posts. Please try again later.</p>';
            }
        };

        // Function to update pagination controls for Admin view
        const updateAdminPaginationControls = (totalPosts) => {
            const paginationControls = document.getElementById('paginationControls');
            if (!paginationControls) return;

            paginationControls.innerHTML = '';

            const totalPages = Math.ceil(totalPosts / adminPostsPerPage);

            if (totalPages > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = 'Previous';
                prevButton.disabled = adminCurrentPage === 0;
                prevButton.addEventListener('click', () => {
                    adminCurrentPage--;
                    loadPostsForAdmin();
                });
                paginationControls.appendChild(prevButton);

                const pageInfo = document.createElement('span');
                pageInfo.textContent = `Page ${adminCurrentPage + 1} of ${totalPages}`;
                paginationControls.appendChild(pageInfo);

                const nextButton = document.createElement('button');
                nextButton.textContent = 'Next';
                nextButton.disabled = adminCurrentPage >= totalPages - 1;
                nextButton.addEventListener('click', () => {
                    adminCurrentPage++;
                    loadPostsForAdmin();
                });
                paginationControls.appendChild(nextButton);
            }
        };

        // Helper function for timeAgo (re-used from embed-posts.html)
        function timeAgo(timestamp) {
            const now = new Date();
            const postDate = timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
            const seconds = Math.floor((now - postDate) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) {
                return Math.floor(interval) + " years ago";
            }
            interval = seconds / 2592000;
            if (interval > 1) {
                return Math.floor(interval) + " months ago";
            }
            interval = seconds / 86400;
            if (interval > 1) {
                return Math.floor(interval) + " days ago";
            }
            interval = seconds / 3600;
            if (interval > 1) {
                return Math.floor(interval) + " hours ago";
            }
            interval = seconds / 60;
            if (interval > 1) {
                return Math.floor(interval) + " minutes ago";
            }
            return Math.floor(seconds) + " seconds ago";
        }
        
    </script>
    <script src="script.js"></script> 
</body>
</html>
