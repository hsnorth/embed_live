<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create/Manage Live Blog</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Noto+Serif:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* New/Adjusted CSS for "Post an Update" section for better cohesiveness */

        /* Target the specific section for post updates */
        .new-post-form {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 800px; /* Limit width for better readability */
            margin: 20px auto; /* Center the section */
        }

        .new-post-form h2 {
            color: #333;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            font-size: 1.5em;
        }

        /* Group form elements for better spacing */
        .new-post-form .form-group {
            margin-bottom: 20px; /* Space between form groups */
        }

        .new-post-form .form-group label {
            display: block; /* Ensures label takes its own line */
            margin-bottom: 8px; /* Space between label and input */
            font-weight: bold;
            color: #555;
        }

        .new-post-form .input-field,
        .new-post-form .textarea-field {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        .new-post-form .textarea-field {
            min-height: 120px; /* Give more vertical space for content */
            resize: vertical; /* Allow vertical resizing */
        }

        .new-post-form .input-field:focus,
        .new-post-form .textarea-field:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Specific styling for the submit button within this form */
        .new-post-form .submit-button {
            background-color: #28a745;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: auto; /* Allow button to size naturally */
            display: inline-block; /* Keeps it in line with text if desired, or makes it block for full width */
            margin-top: 15px; /* Space above the button */
        }

        .new-post-form .submit-button:hover {
            background-color: #218838;
        }

        .new-post-form .submit-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Ensure tab selection group has proper margin */
        .new-post-form .tab-selection-group {
            margin-top: 10px;
            display: flex; /* Arrange checkboxes in a row */
            flex-wrap: wrap; /* Allow wrapping if many tabs */
            gap: 15px; /* Space between checkboxes */
        }

        .new-post-form .tab-selection-group label {
            display: flex; /* Align checkbox and text */
            align-items: center;
            font-weight: normal; /* Labels within tab group don't need bold */
            margin-bottom: 0; /* Remove bottom margin from these labels */
        }

        .new-post-form .tab-selection-group input[type="checkbox"] {
            margin-right: 8px; /* Space between checkbox and label text */
        }

        /* Styling for logged in message */
        .logged-in-message {
            text-align: right;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #666;
        }
        .logged-in-message strong {
            color: #333;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="blogTitleHeader">Loading Blog...</h1>
        <nav>
            <a href="dashboard.html">Dashboard</a>
            <a href="view-blogs.html">Archived Blogs</a>
            <a href="#" id="signOutButtonHeader">Sign Out</a>
        </nav>
    </header>

    <main>
        <section class="tab-management-section">
            <h2>Manage Custom Tabs</h2>
            <div class="tab-management-controls">
                <input type="text" id="newTabNameInput" class="input-field" placeholder="New Tab Name">
                <button id="addTabButton" class="submit-button">Add Tab</button>
            </div>
            <ul id="customTabList" class="tab-list">
            </ul>
        </section>

        <section class="new-post-form">
            <h2>Post an Update</h2>
            <p id="loggedInUserDisplay" class="logged-in-message">
                Logged in as: <img src="" alt="User Avatar" class="user-avatar-small" id="loggedInUserAvatar"> <strong>Loading...</strong> (<a href="#" id="signOutButton">Logout</a>)
            </p>
            <form id="postForm">
                <div class="form-group">
                    <label for="blogIdInput">Blog ID:</label>
                    <input type="text" id="blogIdInput" class="input-field" placeholder="Select a blog..." readonly>
                    <select id="blogSelect" class="input-field" disabled></select>
                </div>

                <div class="form-group">
                    <label for="postSubtitleInput">Subtitle (Optional):</label>
                    <input type="text" id="postSubtitleInput" class="input-field" placeholder="Brief summary or sub-heading">
                </div>

                <div class="form-group">
                    <label for="postContentInput">Post Content:</label>
                    <textarea id="postContentInput" class="textarea-field" placeholder="What's happening?" required></textarea>
                </div>

                <div class="form-group">
                    <label for="postMediaInput">Image or Video (Optional):</label>
                    <input type="file" id="postMediaInput" accept="image/*,video/*">
                </div>

                <div class="form-group">
                    <label>Assign to Tabs:</label>
                    <div id="postTabAssignment" class="tab-selection-group">
                        <label><input type="checkbox" name="postTab" value="Live Reporting" checked disabled> Live Reporting</label>
                    </div>
                </div>

                <button type="submit" class="submit-button">Post Update</button>
            </form>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Live Blog</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, getDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        // !!! IMPORTANT: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG !!!
        const firebaseConfig = {
            apiKey: "AIzaSyDrJsFAJDU4EMficerN2TvOJlio6SYh6lk",
            authDomain: "myliveblogapp-cf9df.firebaseapp.com",
            projectId: "myliveblogapp-cf9df",
            storageBucket: "myliveblogapp-cf9df.firebasestorage.app",
            messagingSenderId: "324824649312",
            appId: "1:324824649312:web:c0750693346091d853bd05",
            measurementId: "G-EZN90844XF"
        };
        // !!! END IMPORTANT !!!

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentUserAvatarUrl = 'https://hsnorth.github.io/embed_live/live/harry.png'; // Default avatar
        let userBlogs = []; // Store blogs specific to the logged-in user
        let selectedBlogId = null;
        let selectedBlogName = '';
        let customTabs = [];
        const defaultTab = "Live Reporting";

        const blogTitleHeader = document.getElementById('blogTitleHeader');
        const loggedInUserDisplay = document.getElementById('loggedInUserDisplay');
        const loggedInUserAvatar = document.getElementById('loggedInUserAvatar');
        const signOutButton = document.getElementById('signOutButton');
        const signOutButtonHeader = document.getElementById('signOutButtonHeader');

        const blogIdInput = document.getElementById('blogIdInput');
        const blogSelect = document.getElementById('blogSelect');
        const postSubtitleInput = document.getElementById('postSubtitleInput');
        const postContentInput = document.getElementById('postContentInput');
        const postMediaInput = document.getElementById('postMediaInput');
        const postTabAssignmentDiv = document.getElementById('postTabAssignment');
        const postForm = document.getElementById('postForm');
        const submitButton = document.querySelector('.new-post-form .submit-button');

        const newTabNameInput = document.getElementById('newTabNameInput');
        const addTabButton = document.getElementById('addTabButton');
        const customTabList = document.getElementById('customTabList');

        // --- Authentication Guard ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html'; // Redirect to login if not authenticated
            } else {
                currentUser = user;
                loggedInUserDisplay.innerHTML = `Logged in as: <strong>${user.displayName || user.email}</strong> (<a href="#" id="signOutButton">Logout</a>)`;

                try {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        if (userData.avatarUrl) {
                            currentUserAvatarUrl = userData.avatarUrl;
                            loggedInUserAvatar.src = currentUserAvatarUrl;
                            loggedInUserAvatar.style.display = 'inline-block';
                        }
                        loggedInUserDisplay.innerHTML = `Logged in as: <img src="${currentUserAvatarUrl}" alt="User Avatar" class="user-avatar-small"> <strong>${userData.name || user.displayName || user.email}</strong> (<a href="#" id="signOutButton">Logout</a>)`;

                    } else {
                        loggedInUserAvatar.src = currentUserAvatarUrl;
                        loggedInUserAvatar.style.display = 'inline-block';
                        console.warn("User document not found in 'users' collection for UID:", currentUser.uid);
                    }
                } catch (error) {
                    console.error("Error fetching user data from Firestore:", error);
                    loggedInUserAvatar.src = currentUserAvatarUrl;
                    loggedInUserAvatar.style.display = 'inline-block';
                }

                // Attach event listeners after the element is confirmed to exist
                document.getElementById('signOutButton').addEventListener('click', async (e) => {
                    e.preventDefault();
                    await handleSignOut();
                });

                await loadUserBlogs();
            }
        });

        const handleSignOut = async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Failed to sign out. Please try again.");
            }
        };

        signOutButtonHeader.addEventListener('click', async (e) => {
            e.preventDefault();
            await handleSignOut();
        });

        // --- Blog Selection Logic ---
        const loadUserBlogs = async () => {
            if (!currentUser) return;

            try {
                const q = query(collection(db, 'blogs'), where('ownerId', '==', currentUser.uid), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                userBlogs = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                blogSelect.innerHTML = '<option value="">-- Select a Blog --</option>';
                userBlogs.forEach(blog => {
                    const option = document.createElement('option');
                    option.value = blog.id;
                    option.textContent = blog.name;
                    blogSelect.appendChild(option);
                });
                blogSelect.disabled = false;

                // Pre-select if a blogId is in URL (for deep linking from dashboard or direct entry)
                const urlParams = new URLSearchParams(window.location.search);
                const blogIdFromUrl = urlParams.get('blogId');
                if (blogIdFromUrl && userBlogs.some(blog => blog.id === blogIdFromUrl)) {
                    blogSelect.value = blogIdFromUrl;
                    handleBlogSelection(blogIdFromUrl);
                } else if (userBlogs.length > 0) {
                    // Automatically select the first blog if no URL param and blogs exist
                    blogSelect.value = userBlogs[0].id;
                    handleBlogSelection(userBlogs[0].id);
                } else {
                    blogTitleHeader.textContent = "Create New Post";
                    blogIdInput.value = "No blogs available";
                    postForm.style.display = 'none'; // Hide post form if no blogs
                    addTabButton.disabled = true;
                    newTabNameInput.disabled = true;
                }

            } catch (error) {
                console.error("Error loading user blogs:", error);
                alert("Failed to load your blogs. Please try refreshing.");
            }
        };

        blogSelect.addEventListener('change', (e) => {
            handleBlogSelection(e.target.value);
        });

        const handleBlogSelection = async (blogId) => {
            selectedBlogId = blogId;
            postForm.style.display = 'block'; // Show post form
            addTabButton.disabled = false;
            newTabNameInput.disabled = false;

            if (selectedBlogId) {
                const selectedBlog = userBlogs.find(blog => blog.id === selectedBlogId);
                if (selectedBlog) {
                    selectedBlogName = selectedBlog.name;
                    blogTitleHeader.textContent = `Post to: ${selectedBlogName}`;
                    blogIdInput.value = selectedBlogName; // Display blog name in readonly input
                    customTabs = selectedBlog.customTabs || [];
                    renderCustomTabs(); // Re-render custom tabs for selected blog
                    renderPostTabAssignmentCheckboxes([]); // Reset and render post assignment checkboxes
                }
            } else {
                selectedBlogName = '';
                blogTitleHeader.textContent = "Create New Post";
                blogIdInput.value = "";
                postForm.style.display = 'none'; // Hide form if no blog selected
                customTabs = [];
                renderCustomTabs();
                renderPostTabAssignmentCheckboxes([]);
            }
        };


        // --- Tab Management Functions ---
        const renderCustomTabs = () => {
            customTabList.innerHTML = '';
            customTabs.forEach(tabName => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="tab-name">${tabName}</span>
                    <button class="delete-tab-button" data-tab-name="${tabName}">Delete</button>
                `;
                customTabList.appendChild(li);
            });
            renderPostTabAssignmentCheckboxes([]); // Re-render post tab assignment when custom tabs change
        };

        const addCustomTab = async () => {
            const newTabName = newTabNameInput.value.trim();
            if (!selectedBlogId) {
                alert("Please select a blog first.");
                return;
            }
            if (newTabName && !customTabs.includes(newTabName) && newTabName.toLowerCase() !== defaultTab.toLowerCase()) {
                customTabs.push(newTabName);
                await updateBlogTabsInFirestore();
                newTabNameInput.value = '';
                renderCustomTabs();
            } else if (newTabName.toLowerCase() === defaultTab.toLowerCase()) {
                alert(`"${defaultTab}" is a default tab and cannot be added as a custom tab.`);
            } else if (customTabs.includes(newTabName)) {
                alert(`Tab "${newTabName}" already exists.`);
            }
        };

        const deleteCustomTab = async (tabName) => {
            if (!selectedBlogId) {
                alert("Please select a blog first.");
                return;
            }
            if (tabName.toLowerCase() === defaultTab.toLowerCase()) {
                alert(`"${defaultTab}" is a default tab and cannot be deleted.`);
                return;
            }
            if (confirm(`Are you sure you want to delete the tab "${tabName}"? This will remove it from all posts it was assigned to.`)) {
                customTabs = customTabs.filter(tab => tab !== tabName);
                await updateBlogTabsInFirestore();
                renderCustomTabs();
            }
        };

        const updateBlogTabsInFirestore = async () => {
            if (selectedBlogId) {
                const blogDocRef = doc(db, 'blogs', selectedBlogId);
                await updateDoc(blogDocRef, { customTabs: customTabs });
            }
        };

        addTabButton.addEventListener('click', addCustomTab);
        customTabList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-tab-button')) {
                deleteCustomTab(e.target.dataset.tabName);
            }
        });

        // --- Post Tab Assignment Checkbox Rendering ---
        const renderPostTabAssignmentCheckboxes = (assignedPostTabs = []) => {
            postTabAssignmentDiv.innerHTML = '';

            const liveReportingCheckbox = document.createElement('label');
            liveReportingCheckbox.innerHTML = `
                <input type="checkbox" name="postTab" value="${defaultTab}" checked disabled>
                ${defaultTab}
            `;
            postTabAssignmentDiv.appendChild(liveReportingCheckbox);

            customTabs.forEach(tabName => {
                const label = document.createElement('label');
                const isChecked = assignedPostTabs.includes(tabName);
                label.innerHTML = `
                    <input type="checkbox" name="postTab" value="${tabName}" ${isChecked ? 'checked' : ''}>
                    ${tabName}
                `;
                postTabAssignmentDiv.appendChild(label);
            });
        };

        // --- Post Form Submission ---
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedBlogId) {
                alert("Please select a blog before posting.");
                return;
            }

            const subtitle = postSubtitleInput.value.trim();
            const content = postContentInput.value.trim();
            const mediaFile = postMediaInput.files[0];

            const selectedTabCheckboxes = postTabAssignmentDiv.querySelectorAll('input[name="postTab"]:checked:not(:disabled)');
            const assignedTabs = [defaultTab]; // Always include "Live Reporting"
            selectedTabCheckboxes.forEach(checkbox => {
                if (checkbox.value !== defaultTab) {
                    assignedTabs.push(checkbox.value);
                }
            });

            if (!content) {
                alert("Post Content is required!");
                return;
            }
            if (assignedTabs.length === 0) {
                alert("Please assign the post to at least one tab.");
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = "Posting...";

            let mediaUrl = '';
            let mediaType = '';

            try {
                if (mediaFile) {
                    const storageRef = ref(storage, `blog_media/${selectedBlogId}/${Date.now()}_${mediaFile.name}`);
                    const uploadTask = uploadBytesResumable(storageRef, mediaFile);
                    await uploadTask;
                    mediaUrl = await getDownloadURL(uploadTask.snapshot.ref);
                    mediaType = mediaFile.type;
                }

                const postsCollectionRef = collection(db, 'posts');

                // Get author's name from current user object or user document
                let authorName = currentUser.displayName || currentUser.email;
                if (currentUser && currentUser.uid) {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists() && userDocSnap.data().name) {
                        authorName = userDocSnap.data().name;
                    }
                }

                await addDoc(postsCollectionRef, {
                    blogId: selectedBlogId,
                    authorId: currentUser.uid,
                    authorName: authorName,
                    authorAvatar: currentUserAvatarUrl,
                    subtitle: subtitle,
                    content: content,
                    mediaUrl: mediaUrl,
                    mediaType: mediaType,
                    assignedTabs: assignedTabs,
                    timestamp: serverTimestamp()
                });

                alert("Post added successfully!");
                postContentInput.value = '';
                postSubtitleInput.value = '';
                postMediaInput.value = '';
                renderPostTabAssignmentCheckboxes([]); // Reset checkboxes to default (Live Reporting selected)

                // Optional: Notify embed if it's on the same domain or controlled
                if (window.parent && window.parent.postMessage) {
                    window.parent.postMessage({ type: 'refreshEmbed', blogId: selectedBlogId }, '*');
                }

            } catch (error) {
                console.error("Error saving post:", error);
                alert("Failed to save post. Please try again. " + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = "Post Update";
            }
        });
    </script>
</body>
</html>
