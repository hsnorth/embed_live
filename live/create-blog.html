<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="blogPageTitle">Create New Live Blog</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        main {
            display: none; /* Hidden until Firebase authentication and data loading is complete */
        }
        .loading-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #555;
        }
        .author-avatar-img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }
        /* Embed section styles */
        .embed-section {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-top: 30px;
        }
        .embed-section h3 {
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .embed-section textarea {
            width: calc(100% - 22px);
            height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
            margin-bottom: 10px;
        }
        .embed-section button {
            background-color: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        .embed-section button:hover {
            background-color: #218838;
        }
        .copy-message {
            margin-top: 10px;
            color: green;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="blogHeaderTitle">My Live Blog</h1>
        <nav>
            <a href="dashboard.html">Dashboard</a>
            <a href="view-blogs.html">Previous Blogs</a>
            <a href="#" id="signOutButtonHeader">Sign Out</a>
        </nav>
    </header>

    <div id="loadingContainer" class="loading-message">
        Loading blog... Please wait.
    </div>

    <main id="mainContent">
        <section class="live-blog-posts">
            <h2>Live Updates</h2>

            <div class="new-post-form">
                <h3>Create a New Post</h3>
                <form id="postForm">
                    <input type="text" id="authorNameInput" placeholder="Your Name" readonly>
                    <input type="text" id="reportingFromInput" placeholder="Reporting From" value="Montreal, Quebec, Canada">
                    <textarea id="postContent" placeholder="What's happening?" rows="5"></textarea>
                    <input type="file" id="postMedia" accept="image/*,video/*">
                    <button type="submit">Post Update</button>
                </form>
            </div>

            <div id="postsContainer">
            </div>
            <div id="paginationControls"></div>
        </section>

        <section class="embed-section">
            <h3>Embed This Live Blog</h3>
            <p>Copy the code below to embed this blog's posts on another website.</p>
            <textarea id="embedCode" rows="6" readonly></textarea>
            <button id="copyEmbedCode">Copy Code</button>
            <span id="copyMessage" class="copy-message" style="display: none;">Copied!</span>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Live Blog</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

        // ðŸš¨ðŸš¨ðŸš¨ YOUR ACTUAL FIREBASE CONFIGURATION ðŸš¨ðŸš¨ðŸš¨
        // This is the configuration you provided.
        const firebaseConfig = {
            apiKey: "AIzaSyDrJsFAJDU4EMficerN2TvOJlio6SYh6lk",
            authDomain: "myliveblogapp-cf9df.firebaseapp.com",
            projectId: "myliveblogapp-cf9df",
            storageBucket: "myliveblogapp-cf9df.firebasestorage.app",
            messagingSenderId: "324824649312",
            appId: "1:324824649312:web:c0750693346091d853bd05",
            measurementId: "G-EZN90844XF"
        };
        // ðŸš¨ðŸš¨ðŸš¨ END OF YOUR FIREBASE CONFIGURATION ðŸš¨ðŸš¨ðŸš¨

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.getDocs = getDocs;
        window.serverTimestamp = serverTimestamp;
        window.auth = auth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getDoc = getDoc;
        window.doc = doc;
        window.signOut = signOut;

        document.getElementById('signOutButtonHeader').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error signing out:", error);
                alert("Could not sign out. Please try again.");
            }
        });

        // Embed code generation logic
        const embedCodeTextarea = document.getElementById('embedCode');
        const copyEmbedCodeButton = document.getElementById('copyEmbedCode');
        const copyMessage = document.getElementById('copyMessage');

        const urlParams = new URLSearchParams(window.location.search);
        const currentBlogId = urlParams.get('blogId');

        if (currentBlogId && embedCodeTextarea) {
            // Construct the URL for the embeddable page
            // Adjust this path based on your GitHub Pages structure
            // Example: If embed-posts.html is in embed_live/live/, then it's /embed_live/live/embed-posts.html
            const embedUrl = `${window.location.origin}/embed_live/live/embed-posts.html?blogId=${currentBlogId}`;
            // Construct the iframe code. Adjust width/height as needed.
            // Height is set to 800px initially, but can be dynamically adjusted by the iframe's content
            const iframeCode = `<iframe src="${embedUrl}" width="100%" height="800px" frameborder="0" scrolling="no" style="border: none; overflow: hidden;" id="liveBlogEmbed-${currentBlogId}"></iframe>`;
            embedCodeTextarea.value = iframeCode;

            copyEmbedCodeButton.addEventListener('click', () => {
                embedCodeTextarea.select();
                document.execCommand('copy');
                copyMessage.style.display = 'inline';
                setTimeout(() => {
                    copyMessage.style.display = 'none';
                }, 2000);
            });

            // Listen for messages from the iframe to adjust its height
            window.addEventListener('message', (event) => {
                // Ensure the message is from a trusted origin (your own domain)
                if (event.origin === window.location.origin && event.data.type === 'iframeHeight') {
                    const iframe = document.getElementById(`liveBlogEmbed-${currentBlogId}`);
                    if (iframe) {
                        // Add a small buffer to the height
                        iframe.style.height = (event.data.height + 20) + 'px'; // +20px for minor padding/margin
                    }
                }
            });

        } else if (embedCodeTextarea) {
            embedCodeTextarea.value = "Please create or select a blog to generate embed code.";
            copyEmbedCodeButton.disabled = true;
        }
    </script>

    <script src="script.js"></script>
</body>
</html>
