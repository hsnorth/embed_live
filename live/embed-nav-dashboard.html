<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigation Dashboard</title>
    <link rel="stylesheet" href="nav-dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <main>
        <div class="filters-container">
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" class="input-field" placeholder="Search claims, topics, names">
            </div>
            <select id="category1Filter" class="input-field filter-dropdown" style="display: none;"></select>
            <select id="category2Filter" class="input-field filter-dropdown" style="display: none;"></select>
            <select id="verdictFilter" class="input-field filter-dropdown">
                <option value="">All Verdicts</option>
                <option value="True">True</option>
                <option value="Half true">Half true</option>
                <option value="Needs context">Needs context</option>
                <option value="Misleading">Misleading</option>
                <option value="False">False</option>
            </select>
        </div>

        <p class="last-updated" id="lastUpdatedText"></p>

        <div id="cardsContainer">
            <!-- Fact-check cards will be rendered here -->
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrJsFAJDU4EMficerN2TvOJlio6SYh6lk",
            authDomain: "myliveblogapp-cf9df.firebaseapp.com",
            projectId: "myliveblogapp-cf9df",
            storageBucket: "myliveblogapp-cf9df.firebasestorage.app",
            messagingSenderId: "324824649312",
            appId: "1:324824649312:web:c0750693346091d853bd05",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allCards = [];
        let currentNavId = null;

        const cardsContainer = document.getElementById('cardsContainer');
        const searchInput = document.getElementById('searchInput');
        const cat1Filter = document.getElementById('category1Filter');
        const cat2Filter = document.getElementById('category2Filter');
        const verdictFilter = document.getElementById('verdictFilter');
        const lastUpdatedText = document.getElementById('lastUpdatedText');

        const renderCards = (cardsToRender) => {
            cardsContainer.innerHTML = '';
            if (cardsToRender.length === 0) {
                cardsContainer.innerHTML = '<p>No matching claims found.</p>';
                return;
            }
            cardsToRender.forEach(card => {
                const cardElement = document.createElement('div');
                const verdictClass = card.verdict ? card.verdict.replace(/\s+/g, '.') : '';
                cardElement.className = `fact-check-card-embed`;
                
                let metaInfoHTML = `<i class="fas fa-clock"></i> <span>${(card.createdAt && card.createdAt.toDate) ? card.createdAt.toDate().toLocaleDateString() : 'N/A'}</span>`;
                if (card.category1) metaInfoHTML += ` <span class="meta-dot">●</span> <span>${card.category1}</span>`;
                if (card.category2) metaInfoHTML += ` <span class="meta-dot">●</span> <span>${card.category2}</span>`;
                if (card.category3) metaInfoHTML += ` <span class="meta-dot">●</span> <span>${card.category3}</span>`;
                
                let verdictIcon = '';
                if (verdictClass === 'True') verdictIcon = '<i class="fas fa-check-circle"></i>';
                if (verdictClass === 'False' || verdictClass === 'Misleading') verdictIcon = '<i class="fas fa-times-circle"></i>';
                if (verdictClass === 'Half.true' || verdictClass === 'Needs.context') verdictIcon = '<i class="fas fa-exclamation-circle"></i>';

                cardElement.innerHTML = `
                    <div class="meta-info">${metaInfoHTML}</div>
                    <div class="card-content">
                        <div class="text-content">
                            <h3 class="title">${card.title}</h3>
                            <p class="subtitle">${card.subtitle}</p>
                            <div class="tags-and-verdict">
                                ${card.verdict ? `<span class="verdict-badge ${verdictClass}">${verdictIcon} ${card.verdict}</span>` : ''}
                            </div>
                        </div>
                        ${card.analysisLink ? `<a href="${card.analysisLink}" target="_blank" class="read-analysis-btn">Read analysis</a>` : ''}
                    </div>
                `;
                cardsContainer.appendChild(cardElement);
            });
        };

        const filterAndRender = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const cat1Value = cat1Filter.value;
            const cat2Value = cat2Filter.value;
            const verdictValue = verdictFilter.value;

            const filteredCards = allCards.filter(card => {
                const matchesSearch = !searchTerm || 
                    card.title.toLowerCase().includes(searchTerm) ||
                    card.subtitle.toLowerCase().includes(searchTerm) ||
                    card.category1.toLowerCase().includes(searchTerm) ||
                    card.category2.toLowerCase().includes(searchTerm) ||
                    card.category3.toLowerCase().includes(searchTerm);
                
                const matchesCat1 = !cat1Value || card.category1 === cat1Value;
                const matchesCat2 = !cat2Value || card.category2 === cat2Value;
                const matchesVerdict = !verdictValue || card.verdict === verdictValue;

                return matchesSearch && matchesCat1 && matchesCat2 && matchesVerdict;
            });
            renderCards(filteredCards);
        };

        const populateFilters = (cards, cat1Name, cat2Name) => {
            const populate = (filterEl, categoryKey, categoryName) => {
                if (!categoryName) {
                    filterEl.style.display = 'none';
                    return;
                }
                filterEl.style.display = 'block';
                const options = [...new Set(cards.map(c => c[categoryKey]).filter(Boolean))];
                filterEl.innerHTML = `<option value="">All ${categoryName}</option>`;
                options.sort().forEach(opt => {
                    filterEl.innerHTML += `<option value="${opt}">${opt}</option>`;
                });
            };
            populate(cat1Filter, 'category1', cat1Name);
            populate(cat2Filter, 'category2', cat2Name);
        };

        const setupRealtimeListener = () => {
            const docRef = doc(db, 'navigationDashboards', currentNavId);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    allCards = data.cards || [];
                    allCards.sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());
                    
                    const updatedDate = data.lastUpdated ? data.lastUpdated.toDate().toLocaleString() : 'N/A';
                    lastUpdatedText.textContent = `Last updated ${updatedDate} · ${allCards.length} checks`;

                    populateFilters(allCards, data.category1Name, data.category2Name);
                    filterAndRender();
                } else {
                    cardsContainer.innerHTML = '<p>Dashboard not found.</p>';
                }
            });
        };

        const init = () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentNavId = urlParams.get('navId');
            if (currentNavId) {
                setupRealtimeListener();
                searchInput.addEventListener('input', filterAndRender);
                cat1Filter.addEventListener('change', filterAndRender);
                cat2Filter.addEventListener('change', filterAndRender);
                verdictFilter.addEventListener('change', filterAndRender);
            } else {
                cardsContainer.innerHTML = '<p>Error: Dashboard ID not found in URL.</p>';
            }
        };

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
