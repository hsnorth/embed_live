<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Blog Posts Embed</title>
    <link rel="stylesheet" href="embed-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Noto+Serif:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <main>
        <section class="live-blog-posts">
            <div id="postsContainer" class="posts-page">
            </div>
        </section>
        <div id="paginationControls" class="pagination-controls"></div>
    </main>

    <button id="newUpdatesButton">
        <i class="fas fa-arrow-up"></i> <span id="newUpdatesCount"></span> New Update
    </button>

    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script async src="//www.instagram.com/embed.js"></script>
    <script async src="https://www.tiktok.com/embed.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, where, getDocs, doc, getDoc, onSnapshot, limit, startAfter } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrJsFAJDU4EMficerN2TvOJlio6SYh6lk",
            authDomain: "myliveblogapp-cf9df.firebaseapp.com",
            projectId: "myliveblogapp-cf9df",
            storageBucket: "myliveblogapp-cf9df.firebase-storage.app",
            messagingSenderId: "324824649312",
            appId: "1:324824649312:web:c0750693346091d853bd05",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentBlogId = null;
        let allPosts = [];
        let pages = [];
        let currentPage = 1;
        const PAGE_HEIGHT = 5000;

        const postsContainer = document.getElementById('postsContainer');
        const paginationControls = document.getElementById('paginationControls');
        const newUpdatesButton = document.getElementById('newUpdatesButton');
        const newUpdatesCountSpan = document.getElementById('newUpdatesCount');

        function timeAgo(timestamp) {
            const now = new Date();
            const postDate = timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
            const seconds = Math.floor((now - postDate) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return `${Math.floor(interval)} years ago`;
            interval = seconds / 2592000;
            if (interval > 1) return `${Math.floor(interval)} months ago`;
            interval = seconds / 86400;
            if (interval > 1) return `${Math.floor(interval)} days ago`;
            interval = seconds / 3600;
            if (interval > 1) return `${Math.floor(interval)} hours ago`;
            interval = seconds / 60;
            if (interval > 1) return `${Math.floor(interval)} minutes ago`;
            return `${Math.floor(seconds)} seconds ago`;
        }

        function processContentForEmbeds(content) {
            if (!content) return '';
            const embedRegex = /(<blockquote[^>]*>.*?<\/blockquote>|<div class="embedded-content-wrapper"[^>]*>.*?<\/div>)/gs;
            const placeholders = [];
            let processedContent = content.replace(embedRegex, (match) => {
                placeholders.push(match);
                return `__EMBED_PLACEHOLDER_${placeholders.length - 1}__`;
            });

            processedContent = processedContent.split(/\r?\n/).map(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('__EMBED_PLACEHOLDER_') || trimmedLine === '') return line;
                return `<p>${line}</p>`;
            }).join('');

            placeholders.forEach((placeholder, index) => {
                processedContent = processedContent.replace(`__EMBED_PLACEHOLDER_${index}__`, placeholder);
            });
            return processedContent;
        }

        function createPostCard(post) {
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.dataset.postId = post.id;
            postCard.id = `post-${post.id}`;

            let pinnedHtml = '';
            if (post.isPinned) {
                postCard.classList.add('pinned');
                pinnedHtml = `<div class="pinned-indicator"><i class="fas fa-thumbtack"></i> PINNED</div>`;
            }

            let mediaHtml = '';
            if (post.mediaUrl) {
                if (post.mediaType && post.mediaType.startsWith('image')) {
                    mediaHtml = `<img src="${post.mediaUrl}" alt="Post Image" class="post-media">`;
                } else if (post.mediaType && post.mediaType.startsWith('video')) {
                    mediaHtml = `<video src="${post.mediaUrl}" poster="${post.mediaUrl}#t=0.1" class="post-media post-video" controls playsinline disablePictureInPicture preload="metadata"></video>`;
                }
            }

            const avatarUrl = post.authorAvatar || 'https://hsnorth.github.io/embed_live/live/harry.png';
            const subtitleHtml = post.subtitle ? `<p class="post-subtitle">${post.subtitle}</p>` : '';
            const fullContentHtml = processContentForEmbeds(post.content);
            let reportingFromDisplay = '';
            if (post.reportingFrom && !post.hideReportingFrom) {
                reportingFromDisplay = `<span>${post.reportingFrom}</span>`;
            }
            const timeAgoHtml = post.isPinned ? '' : `<span class="bullet">â€¢</span> <span class="time-ago">${timeAgo(post.timestamp)}</span>`;

            postCard.innerHTML = `
                ${pinnedHtml}
                <div class="post-header-line">
                    <div class="author-avatar"><img src="${avatarUrl}" alt="Author Avatar" class="author-avatar-img"></div>
                    <div class="post-meta">
                        <div class="meta-line-one"><strong>${post.authorName || 'Anonymous'}</strong>${timeAgoHtml}</div>
                        ${reportingFromDisplay ? `<span class="reporting-from">${reportingFromDisplay}</span>` : ''}
                    </div>
                </div>
                ${subtitleHtml}
                <div class="post-text">${fullContentHtml}</div>
                ${mediaHtml}`;
            return postCard;
        }

        async function calculatePages() {
            postsContainer.innerHTML = ''; // Clear container for calculation
            pages = [];
            let currentPagePosts = [];
            let currentHeight = 0;

            for (const post of allPosts) {
                const postCard = createPostCard(post);
                postsContainer.appendChild(postCard);
                await new Promise(resolve => setTimeout(resolve, 0)); // Allow DOM to update

                // Trigger embed processing to get accurate height
                if (typeof twttr === 'object' && typeof twttr.widgets.load === 'function') twttr.widgets.load(postCard);
                if (typeof instgrm === 'object' && typeof instgrm.Embeds.process === 'function') instgrm.Embeds.process();
                
                await new Promise(resolve => setTimeout(resolve, 50)); // Wait for embeds to potentially resize

                const postHeight = postCard.offsetHeight;
                
                if (currentHeight + postHeight > PAGE_HEIGHT && currentPagePosts.length > 0) {
                    pages.push(currentPagePosts);
                    currentPagePosts = [post];
                    currentHeight = postHeight;
                } else {
                    currentPagePosts.push(post);
                    currentHeight += postHeight;
                }
            }
            if (currentPagePosts.length > 0) {
                pages.push(currentPagePosts);
            }
            postsContainer.innerHTML = '';
        }

        function renderPage(pageNumber) {
            currentPage = pageNumber;
            postsContainer.innerHTML = '';
            const postsToRender = pages[pageNumber - 1] || [];

            if (postsToRender.length === 0) {
                postsContainer.innerHTML = '<p class="no-posts-message">No posts on this page.</p>';
                return;
            }

            postsToRender.forEach(post => {
                const postCard = createPostCard(post);
                postsContainer.appendChild(postCard);
            });

            updatePaginationControls();

            // Process embeds after rendering
            if (typeof twttr === 'object' && typeof twttr.widgets.load === 'function') twttr.widgets.load(postsContainer);
            if (typeof instgrm === 'object' && typeof instgrm.Embeds.process === 'function') instgrm.Embeds.process();
        }

        function updatePaginationControls() {
            paginationControls.innerHTML = '';
            if (pages.length <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => renderPage(currentPage - 1));
            paginationControls.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Page ${currentPage} of ${pages.length}`;
            paginationControls.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.disabled = currentPage === pages.length;
            nextButton.addEventListener('click', () => renderPage(currentPage + 1));
            paginationControls.appendChild(nextButton);
        }

        async function loadInitialPosts() {
            const urlParams = new URLSearchParams(window.location.search);
            currentBlogId = urlParams.get('blogId');
            if (!currentBlogId) {
                postsContainer.innerHTML = '<p class="error-message">Error: Blog ID not found in URL.</p>';
                return;
            }

            const postsCollectionRef = collection(db, 'posts');
            const q = query(postsCollectionRef, where('blogId', '==', currentBlogId), orderBy('timestamp', 'desc'));
            const snapshot = await getDocs(q);
            allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Handle pinned post
            const pinnedPostIndex = allPosts.findIndex(p => p.isPinned);
            if (pinnedPostIndex > -1) {
                const [pinnedPost] = allPosts.splice(pinnedPostIndex, 1);
                allPosts.unshift(pinnedPost);
            }

            await calculatePages();
            renderPage(1);
        }

        document.addEventListener('DOMContentLoaded', loadInitialPosts);
    </script>
</body>
</html>
