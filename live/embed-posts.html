<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Blog Posts Embed</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Embed-specific styles - ONLY for this page */
        body {
            background-color: transparent;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        main {
            padding: 0;
            margin: 0;
            box-shadow: none;
            border-radius: 0;
            background-color: transparent;
            max-width: none;
        }
        .live-blog-posts {
            margin-bottom: 0;
            padding: 0;
            border: none;
            background-color: transparent;
        }
        .live-blog-posts h2 {
            display: none; /* Hide "Live Updates" heading for embed */
        }
        .new-post-form {
            display: none; /* HIDE THE POST FORM FOR EMBED */
        }
        footer {
            display: none; /* Hide footer for embed */
        }
        header {
            display: none; /* Hide header for embed */
        }
        .pagination-controls {
            padding-bottom: 15px;
        }
    </style>
</head>
<body>
    <main>
        <section class="live-blog-posts">
            <div id="postsContainer">
                </div>
            <div id="paginationControls"></div>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        // Note: added 'where' to the import list

        const firebaseConfig = {
            apiKey: "AIzaSyDrJsFAJDU4EMficerN2TvOJlio6SYh6lk",
            authDomain: "myliveblogapp-cf9df.firebaseapp.com",
            projectId: "myliveblogapp-cf9df",
            storageBucket: "myliveblogapp-cf9df.firebasestorage.app",
            messagingSenderId: "324824649312",
            appId: "1:324824649312:web:c0750693346091d853bd05",
            measurementId: "G-EZN90844XF"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Functions previously in embed-script.js, now here ---

        // Function to calculate time ago for posts
        function timeAgo(timestamp) {
            const now = new Date();
            // Check if timestamp is a Firestore Timestamp, convert if it is
            const postDate = timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
            const seconds = Math.floor((now - postDate) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) {
                return Math.floor(interval) + " years ago";
            }
            interval = seconds / 2592000;
            if (interval > 1) {
                return Math.floor(interval) + " months ago";
            }
            interval = seconds / 86400;
            if (interval > 1) {
                return Math.floor(interval) + " days ago";
            }
            interval = seconds / 3600;
            if (interval > 1) {
                return Math.floor(interval) + " hours ago";
            }
            interval = seconds / 60;
            if (interval > 1) {
                return Math.floor(interval) + " minutes ago";
            }
            return Math.floor(seconds) + " seconds ago";
        }

        // Function to render posts
        const renderPosts = (posts, containerId) => {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container with ID "${containerId}" not found.`);
                return;
            }
            container.innerHTML = ''; // Clear existing posts

            if (posts.length === 0) {
                container.innerHTML = '<p class="no-posts-message">No posts yet. Be the first to add an update!</p>';
                return;
            }

            posts.forEach(post => {
                const postCard = document.createElement('div');
                postCard.className = 'post-card';
                postCard.dataset.postId = post.id; // Store Firestore document ID

                let mediaHtml = '';
                if (post.mediaUrl) {
                    if (post.mediaType && post.mediaType.startsWith('image')) {
                        mediaHtml = `<img src="${post.mediaUrl}" alt="Post Image" class="post-media">`;
                    } else if (post.mediaType && post.mediaType.startsWith('video')) {
                        mediaHtml = `<video controls src="${post.mediaUrl}" class="post-media"></video>`;
                    }
                }

                // Default avatar or use a placeholder if none is available
                const avatarUrl = post.authorAvatar || 'https://via.placeholder.com/50?text=ðŸ‘¤'; 

                postCard.innerHTML = `
                    <div class="author-avatar">
                        <img src="${avatarUrl}" alt="Author Avatar" class="author-avatar-img">
                    </div>
                    <div class="post-content-area">
                        <div class="post-meta">
                            <strong>${post.authorName || 'Anonymous'}</strong> 
                            ${post.reportingFrom ? `Reporting from ${post.reportingFrom}` : ''}
                            <span class="time-ago">${timeAgo(post.timestamp)}</span>
                        </div>
                        <p class="post-text">${post.content}</p>
                        ${mediaHtml}
                    </div>
                `;
                container.appendChild(postCard);
            });

            // Notify parent iframe (if any) to adjust height
            if (window.parent) {
                const height = document.body.scrollHeight;
                // Add a small buffer to height to ensure all content and padding is visible
                window.parent.postMessage({ type: 'iframeHeight', height: height + 20 }, window.location.origin);
            }
        };

        // Pagination variables
        let currentPage = 0;
        const postsPerPage = 5; // You can adjust this number

        let currentBlogId = null; // Store the blog ID from the URL
        let allPostsCached = []; // Cache all posts to manage pagination

        // Function to load and display posts
        const loadPosts = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentBlogId = urlParams.get('blogId');

            const postsContainer = document.getElementById('postsContainer');
            const paginationControls = document.getElementById('paginationControls');

            if (!currentBlogId) {
                if (postsContainer) {
                    postsContainer.innerHTML = '<p class="error-message">Error: Blog ID not found in URL. Please provide a valid blog ID.</p>';
                }
                if (paginationControls) {
                    paginationControls.innerHTML = '';
                }
                console.error("Blog ID not found in URL.");
                return;
            }

            try {
                // Only fetch posts if they haven't been cached (first load)
                if (allPostsCached.length === 0) {
                    // *** CRITICAL CHANGE HERE ***
                    const postsCollectionRef = collection(db, 'posts'); // Target top-level 'posts' collection
                    const q = query(
                        postsCollectionRef,
                        where('blogId', '==', currentBlogId), // Filter by the blogId field in each post
                        orderBy('timestamp', 'desc')
                    );
                    const querySnapshot = await getDocs(q);

                    allPostsCached = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log("Fetched posts:", allPostsCached); // Debugging line
                }

                // Apply pagination using the cached posts
                const startIndex = currentPage * postsPerPage;
                const endIndex = startIndex + postsPerPage;
                const postsToShow = allPostsCached.slice(startIndex, endIndex);

                renderPosts(postsToShow, 'postsContainer');
                updatePaginationControls(allPostsCached.length);

            } catch (error) {
                console.error("Error loading posts for embed:", error);
                if (postsContainer) {
                    postsContainer.innerHTML = '<p class="error-message">Error loading posts. Please try again later.</p>';
                }
            }
        };

        // Function to update pagination controls
        const updatePaginationControls = (totalPosts) => {
            const paginationControls = document.getElementById('paginationControls');
            if (!paginationControls) return;

            paginationControls.innerHTML = ''; // Clear previous controls

            const totalPages = Math.ceil(totalPosts / postsPerPage);

            if (totalPages > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = 'Previous';
                prevButton.disabled = currentPage === 0;
                prevButton.addEventListener('click', () => {
                    currentPage--;
                    loadPosts();
                });
                paginationControls.appendChild(prevButton);

                const pageInfo = document.createElement('span');
                pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;
                paginationControls.appendChild(pageInfo);

                const nextButton = document.createElement('button');
                nextButton.textContent = 'Next';
                nextButton.disabled = currentPage >= totalPages - 1;
                nextButton.addEventListener('click', () => {
                    currentPage++;
                    loadPosts();
                });
                paginationControls.appendChild(nextButton);
            }
        };

        // Call loadPosts AFTER the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', loadPosts);

    </script>
</body>
</html>
