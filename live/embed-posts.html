<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Blog Posts Embed</title>
    <link rel="stylesheet" href="embed-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Noto+Serif:wght@400;700&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <main>
        <section class="live-blog-posts">
            <div id="postsContainer">
            </div>
        </section>
        <div id="loadMoreContainer"></div>
    </main>

    <button id="newUpdatesButton">
        <i class="fas fa-arrow-up"></i> <span id="newUpdatesCount"></span> New Update
    </button>

    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script async src="//www.instagram.com/embed.js"></script>
    <script async src="https://www.tiktok.com/embed.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrJsFAJDU4EMficerN2TvOJlio6SYh6lk",
            authDomain: "myliveblogapp-cf9df.firebaseapp.com",
            projectId: "myliveblogapp-cf9df",
            storageBucket: "myliveblogapp-cf9df.firebase-storage.app",
            messagingSenderId: "324824649312",
            appId: "1:324824649312:web:c0750693346091d853bd05",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentBlogId = null;
        let allPosts = [];
        let postsVisibleCount = 0;
        const INITIAL_POST_COUNT = 20;
        const LOAD_MORE_COUNT = 15;

        const postsContainer = document.getElementById('postsContainer');
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        const newUpdatesButton = document.getElementById('newUpdatesButton');
        const newUpdatesCountSpan = document.getElementById('newUpdatesCount');

        function timeAgo(timestamp) {
            const now = new Date();
            const postDate = timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
            const seconds = Math.floor((now - postDate) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return `${Math.floor(interval)} years ago`;
            interval = seconds / 2592000;
            if (interval > 1) return `${Math.floor(interval)} months ago`;
            interval = seconds / 86400;
            if (interval > 1) return `${Math.floor(interval)} days ago`;
            interval = seconds / 3600;
            if (interval > 1) return `${Math.floor(interval)} hours ago`;
            interval = seconds / 60;
            if (interval > 1) return `${Math.floor(interval)} minutes ago`;
            return `${Math.floor(seconds)} seconds ago`;
        }

        function processContentForEmbeds(content) {
            if (!content) return '';
            const embedRegex = /(<blockquote[^>]*>.*?<\/blockquote>|<div class="embedded-content-wrapper"[^>]*>.*?<\/div>)/gs;
            const placeholders = [];
            let processedContent = content.replace(embedRegex, (match) => {
                placeholders.push(match);
                return `__EMBED_PLACEHOLDER_${placeholders.length - 1}__`;
            });

            processedContent = processedContent.split(/\r?\n/).map(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('__EMBED_PLACEHOLDER_') || trimmedLine === '') return line;
                return `<p>${line}</p>`;
            }).join('');

            placeholders.forEach((placeholder, index) => {
                processedContent = processedContent.replace(`__EMBED_PLACEHOLDER_${index}__`, placeholder);
            });
            return processedContent;
        }

        function createPostCard(post) {
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.dataset.postId = post.id;
            postCard.id = `post-${post.id}`;

            let pinnedHtml = '';
            if (post.isPinned) {
                postCard.classList.add('pinned');
                pinnedHtml = `<div class="pinned-indicator"><i class="fas fa-thumbtack"></i> PINNED</div>`;
            }

            let mediaHtml = '';
            if (post.mediaUrl) {
                if (post.mediaType && post.mediaType.startsWith('image')) {
                    mediaHtml = `<img src="${post.mediaUrl}" alt="Post Image" class="post-media">`;
                } else if (post.mediaType && post.mediaType.startsWith('video')) {
                    mediaHtml = `<video src="${post.mediaUrl}" poster="${post.mediaUrl}#t=0.1" class="post-media post-video" controls playsinline disablePictureInPicture preload="metadata"></video>`;
                }
            }

            const avatarUrl = post.authorAvatar || 'https://hsnorth.github.io/embed_live/live/harry.png';
            const subtitleHtml = post.subtitle ? `<p class="post-subtitle">${post.subtitle}</p>` : '';
            const fullContentHtml = processContentForEmbeds(post.content);
            let reportingFromDisplay = '';
            if (post.reportingFrom && !post.hideReportingFrom) {
                reportingFromDisplay = `<span>${post.reportingFrom}</span>`;
            }
            const timeAgoHtml = post.isPinned ? '' : `<span class="bullet">â€¢</span> <span class="time-ago">${timeAgo(post.timestamp)}</span>`;

            postCard.innerHTML = `
                ${pinnedHtml}
                <div class="post-header-line">
                    <div class="author-avatar"><img src="${avatarUrl}" alt="Author Avatar" class="author-avatar-img"></div>
                    <div class="post-meta">
                        <div class="meta-line-one"><strong>${post.authorName || 'Anonymous'}</strong>${timeAgoHtml}</div>
                        ${reportingFromDisplay ? `<span class="reporting-from">${reportingFromDisplay}</span>` : ''}
                    </div>
                </div>
                ${subtitleHtml}
                <div class="post-text">${fullContentHtml}</div>
                ${mediaHtml}`;
            return postCard;
        }

        // START CHANGE: This function now only appends posts, it doesn't clear the container.
        function renderPosts(postsToRender) {
            if (postsToRender.length === 0 && postsContainer.children.length === 0) {
                postsContainer.innerHTML = '<p class="no-posts-message">No posts yet.</p>';
                return;
            }

            postsToRender.forEach(post => {
                const postCard = createPostCard(post);
                postsContainer.appendChild(postCard);
            });

            if (typeof twttr === 'object' && typeof twttr.widgets.load === 'function') twttr.widgets.load(postsContainer);
            if (typeof instgrm === 'object' && typeof instgrm.Embeds.process === 'function') instgrm.Embeds.process();
            
            if (window.parent) {
                setTimeout(() => {
                    const height = document.body.scrollHeight;
                    window.parent.postMessage({ type: 'iframeHeight', height: height + 20 }, '*');
                }, 500);
            }
        }
        // END CHANGE

        function updateLoadMoreButton() {
            loadMoreContainer.innerHTML = '';
            if (postsVisibleCount < allPosts.length) {
                const loadMoreButton = document.createElement('button');
                loadMoreButton.textContent = 'Load More Posts';
                loadMoreButton.className = 'load-more-button';
                loadMoreButton.addEventListener('click', () => {
                    // START CHANGE: Logic to append only the new posts
                    const oldVisibleCount = postsVisibleCount;
                    postsVisibleCount = Math.min(postsVisibleCount + LOAD_MORE_COUNT, allPosts.length);
                    const postsToAdd = allPosts.slice(oldVisibleCount, postsVisibleCount);
                    renderPosts(postsToAdd);
                    updateLoadMoreButton();
                    // END CHANGE
                });
                loadMoreContainer.appendChild(loadMoreButton);
            }
        }

        async function loadInitialPosts() {
            const urlParams = new URLSearchParams(window.location.search);
            currentBlogId = urlParams.get('blogId');
            if (!currentBlogId) {
                postsContainer.innerHTML = '<p class="error-message">Error: Blog ID not found in URL.</p>';
                return;
            }

            const postsCollectionRef = collection(db, 'posts');
            const q = query(postsCollectionRef, where('blogId', '==', currentBlogId), orderBy('timestamp', 'desc'));
            const snapshot = await getDocs(q);
            allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const pinnedPostIndex = allPosts.findIndex(p => p.isPinned);
            if (pinnedPostIndex > -1) {
                const [pinnedPost] = allPosts.splice(pinnedPostIndex, 1);
                allPosts.unshift(pinnedPost);
            }

            // START CHANGE: Clear container only on initial load and render the first batch
            postsContainer.innerHTML = '';
            postsVisibleCount = Math.min(INITIAL_POST_COUNT, allPosts.length);
            const initialPosts = allPosts.slice(0, postsVisibleCount);
            renderPosts(initialPosts);
            updateLoadMoreButton();
            // END CHANGE
        }

        document.addEventListener('DOMContentLoaded', loadInitialPosts);

        onSnapshot(query(collection(db, 'posts'), where('blogId', '==', currentBlogId)), (snapshot) => {
            const newPostCount = snapshot.docs.length;
            if (newPostCount > allPosts.length && allPosts.length > 0) {
                 newUpdatesButton.style.display = 'block';
                 newUpdatesCountSpan.textContent = newPostCount - allPosts.length;
            }
        });
        
        newUpdatesButton.addEventListener('click', () => {
            newUpdatesButton.style.display = 'none';
            loadInitialPosts();
        });

    </script>
</body>
</html>
