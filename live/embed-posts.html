<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Blog Embed</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Embed-specific overrides to ensure transparency and clean integration */
        body {
            background-color: transparent !important;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
            min-height: 100vh; /* Ensure body takes full height for proper scrollHeight calculation */
            font-family: 'Inter', sans-serif;
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Basic container styling to ensure no extra padding/margin */
        main, .live-blog-posts {
            background-color: transparent !important;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            width: 100%;
        }

        /* Variables for easy theme customization */
        :root {
            --primary-color: #007bff; /* A nice blue for active elements */
            --primary-darker-color: #0056b3; /* Darker blue for hover states */
            --accent-color: #28a745; /* Green for current page/new updates */
            --danger-color: #dc3545; /* Red for errors */
            --text-color: #343a40;
            --light-grey: #f8f9fa;
            --medium-grey: #e9ecef;
            --border-color: #dee2e6;
            --highlight-yellow: #fffbe6; /* Light yellow for post highlight */
        }

        /* Hide elements not relevant for the embed */
        h2, .new-post-form, footer, header {
            display: none !important;
        }

        /* Live Blog Posts Container */
        .live-blog-posts {
            padding: 15px; /* Add some padding around the posts */
            box-sizing: border-box;
            background-color: transparent;
        }

        .error-message {
            color: var(--danger-color);
            text-align: center;
            padding: 20px;
            font-weight: 500;
        }

        .no-posts-message {
            text-align: center;
            color: var(--text-color);
            padding: 20px;
        }

        /* Post Card Styling */
        .post-card {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.3s ease;
        }

        .post-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            position: relative; /* For the live dot positioning */
        }

        .author-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border-radius: 50%;
            position: relative; /* Added for correct positioning of the ::before pseudo-element */
        }

        /* Live indicator dot */
        .author-avatar-img.live::before {
            content: '';
            position: absolute;
            top: 0px; /* Adjust as needed */
            left: 0px; /* Adjust as needed */
            width: 10px;
            height: 10px;
            background-color: #34D399; /* Bright green */
            border-radius: 50%;
            border: 2px solid white; /* White border to make it stand out */
            z-index: 10;
        }

        .post-meta {
            flex-grow: 1;
        }

        .post-author {
            font-weight: 600;
            color: var(--primary-darker-color);
            font-size: 15px;
            margin-bottom: 2px;
        }

        .post-timestamp {
            font-size: 12px;
            color: #6c757d;
        }

        .post-subtitle {
            font-weight: 500;
            color: var(--text-color);
            margin-top: 8px;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .post-content p {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
            color: var(--text-color);
            word-wrap: break-word; /* Ensure long words break */
        }

        .post-content p:last-child {
            margin-bottom: 0;
        }

        .show-more-button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            padding: 0;
            margin-top: 5px;
            display: inline-block;
        }

        .show-more-button:hover {
            text-decoration: underline;
        }

        .post-media {
            margin-top: 10px;
            border-radius: 6px;
            overflow: hidden;
            max-width: 100%;
            height: auto;
            display: block; /* Ensures no extra space below images */
        }

        .post-video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            margin-top: 10px;
            border-radius: 6px;
            overflow: hidden;
            background-color: black; /* Placeholder background */
            cursor: pointer;
        }

        .post-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* Ensures video fits within container without cropping */
            display: block;
        }

        .post-tags {
            margin-top: 10px;
        }

        .post-tags span {
            display: inline-block;
            background-color: var(--light-grey);
            color: var(--text-color);
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        /* Copy link button */
        .copy-link-button {
            background-color: var(--medium-grey);
            color: var(--text-color);
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s ease;
        }

        .copy-link-button:hover {
            background-color: var(--border-color);
        }

        .copy-link-button.copied {
            background-color: var(--accent-color);
            color: white;
        }
        
        /* Expanded video overlay */
        .expanded-video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px); /* Optional: blur background content */
        }

        .expanded-video-overlay video {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* Prevent scrolling on body when video is expanded */
        body.video-expanded {
            overflow: hidden;
        }

        /* New Updates Button */
        #newUpdatesButton {
            position: sticky;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 999;
            display: none; /* Hidden by default */
            transition: background-color 0.3s ease, transform 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping */
        }

        #newUpdatesButton:hover {
            background-color: #218838; /* Darker green on hover */
            transform: translateX(-50%) translateY(-2px);
        }

        #newUpdatesButton .new-updates-count {
            background-color: white;
            color: var(--accent-color);
            border-radius: 50%;
            padding: 2px 7px;
            margin-left: 8px;
            font-size: 12px;
            font-weight: bold;
        }

        /* Tab Navigation */
        #tabNavigation {
            display: flex;
            justify-content: flex-start; /* Align tabs to the start */
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            position: sticky; /* Make it sticky */
            top: 0; /* Stick to the top of its container */
            z-index: 100; /* Ensure it stays above posts */
            overflow-x: auto; /* Allow horizontal scrolling for many tabs */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            white-space: nowrap; /* Prevent tabs from wrapping */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        #tabNavigation::-webkit-scrollbar {
            height: 5px;
        }

        #tabNavigation::-webkit-scrollbar-thumb {
            background: var(--medium-grey);
            border-radius: 5px;
        }

        #tabNavigation::-webkit-scrollbar-track {
            background: var(--light-grey);
        }

        .tab-button {
            background-color: var(--light-grey);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 20px; /* Pill shape */
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            flex-shrink: 0; /* Prevent tabs from shrinking */
        }

        .tab-button:hover {
            background-color: var(--medium-grey);
        }

        .tab-button.active-tab {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            pointer-events: none; /* Disable click on active tab */
        }

        /* Pagination Controls */
        .pagination-controls {
            display: flex;
            justify-content: center; /* Ensures horizontal centering */
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px; /* Add margin at the bottom as well */
            flex-wrap: wrap;
            padding: 10px;
            background-color: transparent;
        }

        .pagination-controls .pagination-button, /* Targeting the Previous/Next buttons specifically */
        .pagination-controls .page-number {      /* Targeting the numerical page spans */
            background-color: var(--primary-color); /* Light blue */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px; /* Adjusted for better visibility of text characters */
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 35px; /* Ensures consistent button size */
        }

        .pagination-controls .pagination-button:hover:not(:disabled),
        .pagination-controls .page-number:hover:not(.current-page) {
            background-color: var(--primary-darker-color); /* Darker blue */
            transform: translateY(-2px);
        }

        .pagination-controls .pagination-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .pagination-controls .page-number.current-page {
            background-color: var(--accent-color); /* Green for current page */
            color: white;
            cursor: default;
            transform: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .pagination-controls .ellipsis {
            color: var(--text-color);
            padding: 8px 0px; /* Adjust padding to align vertically with buttons */
            font-size: 16px; /* Ensure consistency with button text size */
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .post-card {
                padding: 12px;
            }
            .post-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .post-meta {
                text-align: left;
            }
            .pagination-controls {
                gap: 8px;
                padding: 5px;
            }
            .pagination-controls button,
            .pagination-controls .page-number {
                padding: 6px 10px;
                font-size: 13px;
                min-width: 30px;
            }
            .tab-button {
                padding: 7px 12px;
                font-size: 13px;
            }
            #newUpdatesButton {
                padding: 8px 16px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <main>
        <section class="live-blog-posts">
            <div id="tabNavigation">
                </div>
            <div id="postsContainer">
                </div>
            <div id="paginationControls">
                </div>
            <button id="newUpdatesButton" style="display: none;">
                New Updates <span class="new-updates-count"></span>
            </button>
        </section>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your Firebase configuration - REPLACE THESE WITH YOUR ACTUAL VALUES
        const firebaseConfig = {
            apiKey: "AIzaSyDrJsFAJDU4EMficerN2TvOJlio6SYh6lk", // REPLACE THIS
            authDomain: "myliveblogapp-cf9df.firebaseapp.com", // REPLACE THIS
            projectId: "myliveblogapp-cf9df", // REPLACE THIS
            storageBucket: "myliveblogapp-cf9df.firebase-storage.app", // REPLACE THIS
            messagingSenderId: "324824649312", // REPLACE THIS
            appId: "1:324824649312:web:c0750693346091d853bd05", // REPLACE THIS
            measurementId: "G-EZN90844XF" // REPLACE THIS (optional)
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global Variables ---
        let currentBlogId = null;
        let allPostsCached = []; // Stores all fetched posts
        let filteredPosts = []; // Posts after applying tab filter
        let currentPage = 0;
        const postsPerPage = 5; // Number of posts to show per page
        let unsubscribeFromPosts = null; // To manage the real-time listener
        const defaultTab = "Live Reporting";
        let customTabs = [];
        let currentActiveTab = defaultTab;
        let initialLoadComplete = false; // Flag to handle initial deep link vs. new updates
        let newUpdatesCount = 0;

        // --- DOM Elements ---
        const postsContainer = document.getElementById('postsContainer');
        const paginationControls = document.getElementById('paginationControls');
        const tabNavigationDiv = document.getElementById('tabNavigation');
        const newUpdatesButton = document.getElementById('newUpdatesButton');

        // --- Helper Function: timeAgo (Calculates time elapsed) ---
        const timeAgo = (timestamp) => {
            if (!timestamp) return 'N/A';
            const seconds = Math.floor((new Date() - timestamp.toDate()) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return Math.floor(seconds) + "s ago";
        };

        // --- Helper Function: renderPosts (Renders posts to a given container) ---
        const renderPosts = (posts, containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = ''; // Clear existing posts

            if (posts.length === 0) {
                container.innerHTML = '<p class="no-posts-message">No posts found for this selection.</p>';
                return;
            }

            posts.forEach(post => {
                const MAX_CHARS_PREVIEW = 300; // Max characters for content preview

                const postCard = document.createElement('div');
                postCard.className = 'post-card';
                postCard.id = `post-${post.id}`; // Add ID for deep linking

                let postContentHTML = post.content;
                let showMoreButtonHTML = '';

                if (post.content && post.content.length > MAX_CHARS_PREVIEW) {
                    postContentHTML = post.content.substring(0, MAX_CHARS_PREVIEW) + '...';
                    showMoreButtonHTML = '<button class="show-more-button">Show more</button>';
                }

                const subtitleHTML = post.subtitle ? `<h3 class="post-subtitle">${post.subtitle}</h3>` : '';

                let mediaHTML = '';
                if (post.mediaUrl) {
                    if (post.mediaType === 'image') {
                        mediaHTML = `<img src="${post.mediaUrl}" alt="Post Media" class="post-media">`;
                    } else if (post.mediaType === 'video') {
                        // Use preload="metadata" to load enough info for poster frame without full video
                        mediaHTML = `
                            <div class="post-video-container">
                                <video class="post-video" src="${post.mediaUrl}" preload="metadata" playsinline muted></video>
                            </div>
                        `;
                    }
                }

                const tagsHTML = post.tags && post.tags.length > 0
                    ? `<div class="post-tags">${post.tags.map(tag => `<span>${tag}</span>`).join('')}</div>`
                    : '';
                
                // Get a default avatar if none is provided
                const avatarUrl = post.authorAvatar || 'https://via.placeholder.com/40?text=A';

                postCard.innerHTML = `
                    <div class="post-header">
                        <div class="author-avatar">
                            <img src="${avatarUrl}" alt="${post.authorName}'s avatar" class="author-avatar-img ${post.isLive ? 'live' : ''}">
                        </div>
                        <div class="post-meta">
                            <div class="post-author">${post.authorName || 'Anonymous'}</div>
                            <div class="post-timestamp">${timeAgo(post.timestamp)}</div>
                        </div>
                    </div>
                    ${subtitleHTML}
                    <div class="post-content">
                        <p>${postContentHTML}</p>
                        ${showMoreButtonHTML}
                    </div>
                    ${mediaHTML}
                    ${tagsHTML}
                    <button class="copy-link-button">
                        Copy Link
                    </button>
                `;
                container.appendChild(postCard);

                // Add event listener for "Show more" button
                if (post.content && post.content.length > MAX_CHARS_PREVIEW) {
                    const showMoreButton = postCard.querySelector('.show-more-button');
                    const contentParagraph = postCard.querySelector('.post-content p');
                    showMoreButton.addEventListener('click', () => {
                        contentParagraph.innerHTML = post.content;
                        showMoreButton.style.display = 'none';
                        // Notify parent iframe to adjust height after content expands
                        if (window.parent) {
                            const height = document.body.scrollHeight;
                            window.parent.postMessage({ type: 'iframeHeight', height: height + 20 }, window.location.origin);
                        }
                    });
                }

                // Add event listener for Copy Link button
                const copyLinkButton = postCard.querySelector('.copy-link-button');
                if (copyLinkButton) {
                    copyLinkButton.addEventListener('click', async () => {
                        const deepLink = `${window.location.origin}/embed_live/live/embed-posts.html?blogId=${currentBlogId}#post-${post.id}`;
                        try {
                            await navigator.clipboard.writeText(deepLink);
                            copyLinkButton.textContent = 'Copied!';
                            copyLinkButton.classList.add('copied');
                            setTimeout(() => {
                                copyLinkButton.textContent = 'Copy Link';
                                copyLinkButton.classList.remove('copied');
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy link:', err);
                            alert('Failed to copy link. Please copy it manually.');
                        }
                    });
                }

                // Add event listener for video playback/expansion
                const videoContainer = postCard.querySelector('.post-video-container');
                if (videoContainer) {
                    const videoElement = videoContainer.querySelector('.post-video');
                    videoContainer.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent post card click if it had one

                        // Create overlay for full-screen video
                        const overlay = document.createElement('div');
                        overlay.className = 'expanded-video-overlay';

                        const fullVideo = videoElement.cloneNode(true);
                        fullVideo.controls = true;
                        fullVideo.autoplay = true;
                        fullVideo.muted = false; // Unmute by default in expanded view
                        fullVideo.loop = false;
                        fullVideo.playsinline = false; // Allow fullscreen on iOS

                        overlay.appendChild(fullVideo);
                        document.body.appendChild(overlay);
                        document.body.classList.add('video-expanded'); // Add class to prevent body scroll

                        // Pause the small video and reset its time
                        videoElement.pause();
                        videoElement.currentTime = 0;

                        const closeVideo = () => {
                            overlay.remove();
                            document.body.classList.remove('video-expanded');
                            // Notify parent iframe to readjust height (in case body overflow hidden affected it)
                            if (window.parent) {
                                const height = document.body.scrollHeight;
                                window.parent.postMessage({ type: 'iframeHeight', height: height + 20 }, window.location.origin);
                            }
                        };

                        overlay.addEventListener('click', closeVideo); // Close when clicking overlay
                        fullVideo.addEventListener('click', (ev) => ev.stopPropagation()); // Prevent closing when clicking video
                        fullVideo.addEventListener('ended', closeVideo); // Close when video ends
                    });
                }
            });

            // Notify parent iframe (if any) to adjust height after posts render
            if (window.parent) {
                const height = document.body.scrollHeight;
                window.parent.postMessage({ type: 'iframeHeight', height: height + 20 }, window.location.origin);
            }
        };

        // --- Function: setupRealtimeListener (Fetches and listens for real-time post updates) ---
        const setupRealtimeListener = (blogId) => {
            if (unsubscribeFromPosts) {
                unsubscribeFromPosts(); // Unsubscribe from previous listener if exists
            }

            const postsCollectionRef = collection(db, 'posts');
            const q = query(postsCollectionRef,
                // Add filter for current blogId
                // where('blogId', '==', blogId), // Uncomment this line if you have a blogId field in posts
                orderBy('timestamp', 'desc')
            );

            unsubscribeFromPosts = onSnapshot(q, (snapshot) => {
                const updatedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const oldPostIds = new Set(allPostsCached.map(p => p.id));
                const newPostIds = new Set(updatedPosts.map(p => p.id));

                let newPostsDetected = false;
                if (initialLoadComplete) { // Only count new posts after initial load
                    for (const id of newPostIds) {
                        if (!oldPostIds.has(id)) {
                            newPostsDetected = true;
                            newUpdatesCount++;
                        }
                    }
                }

                allPostsCached = updatedPosts; // Update the cache with latest data
                
                // If there are new posts and user is scrolled down, show "New Updates" button
                if (newPostsDetected && window.scrollY > 0) {
                    newUpdatesButton.style.display = 'flex'; // Use flex to center icon/text
                    const countSpan = newUpdatesButton.querySelector('.new-updates-count');
                    if (countSpan) countSpan.textContent = newUpdatesCount;
                } else {
                    // If no new posts, or user is at the top, just re-render immediately
                    newUpdatesCount = 0;
                    newUpdatesButton.style.display = 'none';
                    filterAndRenderPosts(); // Re-filter and render with latest data
                }

                // Handle deep linking on initial load
                if (!initialLoadComplete && window.location.hash) {
                    const postId = window.location.hash.substring(1).replace('post-', '');
                    if (postId) {
                        scrollToPost(postId);
                    }
                }

                initialLoadComplete = true; // Set flag after the first snapshot
            }, (error) => {
                console.error("Error fetching posts:", error);
                postsContainer.innerHTML = '<p class="error-message">Error loading posts. Please try again later.</p>';
            });
        };

        // --- Function: scrollToPost (Scrolls to a specific post and highlights it) ---
        const scrollToPost = (postId) => {
            const postIndex = filteredPosts.findIndex(post => post.id === postId);
            if (postIndex === -1) {
                console.warn(`Post with ID ${postId} not found in filtered posts.`);
                return;
            }

            const targetPage = Math.floor(postIndex / postsPerPage);

            if (currentPage !== targetPage) {
                currentPage = targetPage;
                renderCurrentPage(); // Render the correct page first
            }

            // Small delay to allow rendering
            setTimeout(() => {
                const targetElement = document.getElementById(postId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    targetElement.style.transition = 'background-color 0.5s ease-in-out';
                    targetElement.style.backgroundColor = '#fffbe6'; // Light yellow highlight
                    setTimeout(() => {
                        targetElement.style.backgroundColor = ''; // Remove highlight
                    }, 3000);
                }
            }, 100);
        };

        // --- Function: loadPosts (Initial loading of blog ID and setting up listeners) ---
        const loadPosts = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentBlogId = urlParams.get('blogId');

            if (!currentBlogId) {
                postsContainer.innerHTML = '<p class="error-message">Error: Blog ID not found in URL. Please provide a valid blog ID.</p>';
                paginationControls.innerHTML = '';
                tabNavigationDiv.innerHTML = '';
                console.error("Blog ID not found in URL.");
                return;
            }

            try {
                // Fetch blog details to get custom tabs
                const blogDocRef = doc(db, 'blogs', currentBlogId);
                const blogDocSnap = await getDoc(blogDocRef);
                if (blogDocSnap.exists()) {
                    customTabs = blogDocSnap.data().customTabs || [];
                }
                
                renderTabs(); // Render/update tabs based on fetched data
                setupRealtimeListener(currentBlogId); // Start listening for real-time updates
                
            } catch (error) {
                console.error("Error loading blog details for embed:", error);
                postsContainer.innerHTML = '<p class="error-message">Error loading blog details. Please try again later.</p>';
            }
        };

        // --- Function: filterAndRenderPosts (Filters posts by active tab and re-renders) ---
        const filterAndRenderPosts = () => {
            if (currentActiveTab === defaultTab) {
                filteredPosts = allPostsCached; // Show all if default tab is active
            } else {
                filteredPosts = allPostsCached.filter(post => 
                    post.assignedTabs && post.assignedTabs.includes(currentActiveTab) // Filter by assigned tabs
                );
            }

            // If we're coming from a deep link, currentPage might have been set by scrollToPost
            // Otherwise, reset to the first page when tab changes or initially loads
            if (!window.location.hash || initialLoadComplete) { // Only reset if not an initial deep link load
                currentPage = 0; 
            }
            renderCurrentPage(); // Render the current page and update pagination controls
        };

        // --- Function: updatePaginationControls (Generates and updates the pagination links) ---
        const updatePaginationControls = (totalPosts) => {
            const paginationControls = document.getElementById('paginationControls');
            if (!paginationControls) return;

            paginationControls.innerHTML = ''; // Clear existing controls

            const totalPages = Math.ceil(totalPosts / postsPerPage);

            if (totalPages > 1) { // Only show pagination if more than one page
                // Previous button
                const prevButton = document.createElement('button');
                prevButton.innerHTML = '&laquo;'; // Left double angle quote character
                prevButton.disabled = currentPage === 0; // Disable if on first page
                prevButton.title = 'Previous Page';
                prevButton.classList.add('pagination-button'); // Added class
                prevButton.addEventListener('click', () => {
                    currentPage--;
                    renderCurrentPage();
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top on page change
                });
                paginationControls.appendChild(prevButton);

                // Page numbers and ellipsis logic
                const maxPagesToShow = 5; // Max number of page numbers (e.g., < 1, 2, ..., 5 >)
                let startPage, endPage;

                if (totalPages <= maxPagesToShow) {
                    // Less than or equal to maxPagesToShow, show all pages
                    startPage = 0;
                    endPage = totalPages - 1;
                } else {
                    // More than maxPagesToShow, implement ellipsis logic
                    if (currentPage < maxPagesToShow - 2) { // Near the beginning (e.g., 1, 2, 3, ..., N)
                        startPage = 0;
                        endPage = maxPagesToShow - 2; 
                    } else if (currentPage > totalPages - (maxPagesToShow - 1)) { // Near the end (e.g., 1, ..., N-2, N-1, N)
                        startPage = totalPages - (maxPagesToShow - 1); 
                        endPage = totalPages - 1;
                    } else { // In the middle (e.g., 1, ..., C-1, C, C+1, ..., N)
                        startPage = currentPage - 1; 
                        endPage = currentPage + 1;
                    }
                }

                // Add first page number and leading ellipsis if needed
                if (startPage > 0) {
                    const firstPageSpan = document.createElement('span');
                    firstPageSpan.textContent = '1';
                    firstPageSpan.className = 'page-number';
                    firstPageSpan.addEventListener('click', () => {
                        currentPage = 0;
                        renderCurrentPage();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                    paginationControls.appendChild(firstPageSpan);

                    if (startPage > 1) { // Only show ellipsis if there's a gap
                        const ellipsisSpan = document.createElement('span');
                        ellipsisSpan.textContent = '...';
                        ellipsisSpan.className = 'ellipsis';
                        paginationControls.appendChild(ellipsisSpan);
                    }
                }

                // Add dynamic page numbers
                for (let i = startPage; i <= endPage; i++) {
                    const pageNumSpan = document.createElement('span');
                    pageNumSpan.textContent = i + 1; // Display 1-based index
                    pageNumSpan.className = 'page-number';
                    if (i === currentPage) {
                        pageNumSpan.classList.add('current-page'); // Highlight current page
                    }
                    pageNumSpan.addEventListener('click', () => {
                        if (currentPage !== i) { // Only update if changing page
                            currentPage = i;
                            renderCurrentPage();
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                    paginationControls.appendChild(pageNumSpan);
                }

                // Add trailing ellipsis and last page number if needed
                if (endPage < totalPages - 1) {
                    if (endPage < totalPages - 2) { // Only show ellipsis if there's a gap
                        const ellipsisSpan = document.createElement('span');
                        ellipsisSpan.textContent = '...';
                        ellipsisSpan.className = 'ellipsis';
                        paginationControls.appendChild(ellipsisSpan);
                    }
                    const lastPageSpan = document.createElement('span');
                    lastPageSpan.textContent = totalPages;
                    lastPageSpan.className = 'page-number';
                    lastPageSpan.addEventListener('click', () => {
                        currentPage = totalPages - 1;
                        renderCurrentPage();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                    paginationControls.appendChild(lastPageSpan);
                }

                // Next button
                const nextButton = document.createElement('button');
                nextButton.innerHTML = '&raquo;'; // Right double angle quote character
                nextButton.disabled = currentPage >= totalPages - 1; // Disable if on last page
                nextButton.title = 'Next Page';
                nextButton.classList.add('pagination-button'); // Added class
                nextButton.addEventListener('click', () => {
                    currentPage++;
                    renderCurrentPage();
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top on page change
                });
                paginationControls.appendChild(nextButton);
            }
            // Notify parent iframe (if any) to adjust height after pagination renders/updates
            if (window.parent) {
                const height = document.body.scrollHeight;
                window.parent.postMessage({ type: 'iframeHeight', height: height + 20 }, window.location.origin);
            }
        };

        // --- Function: renderCurrentPage (Calculates posts for current page and renders them) ---
        const renderCurrentPage = () => {
            const startIndex = currentPage * postsPerPage;
            const endIndex = startIndex + postsPerPage;
            const postsToShow = filteredPosts.slice(startIndex, endIndex);

            renderPosts(postsToShow, 'postsContainer');
            updatePaginationControls(filteredPosts.length);
        };

        // --- Function: renderTabs (Renders the tab navigation buttons) ---
        const renderTabs = () => {
            tabNavigationDiv.innerHTML = ''; // Clear existing tabs

            // Always add the default "Live Reporting" tab
            const liveReportingButton = document.createElement('button');
            liveReportingButton.textContent = defaultTab;
            liveReportingButton.classList.add('tab-button');
            if (currentActiveTab === defaultTab) {
                liveReportingButton.classList.add('active-tab'); // Set active class
            }
            liveReportingButton.addEventListener('click', () => {
                currentActiveTab = defaultTab;
                renderTabs(); // Re-render tabs to update active state
                filterAndRenderPosts(); // Filter and render posts for the new tab
            });
            tabNavigationDiv.appendChild(liveReportingButton);

            // Add custom tabs from Firestore
            customTabs.forEach(tabName => {
                const tabButton = document.createElement('button');
                tabButton.textContent = tabName;
                tabButton.classList.add('tab-button');
                if (currentActiveTab === tabName) {
                    tabButton.classList.add('active-tab'); // Set active class
                }
                tabButton.addEventListener('click', () => {
                    currentActiveTab = tabName;
                    renderTabs(); // Re-render tabs to update active state
                    filterAndRenderPosts(); // Filter and render posts for the new tab
                });
                tabNavigationDiv.appendChild(tabButton);
            });
        };

        // --- Event Listener: DOMContentLoaded (Initializes the embed when the page loads) ---
        document.addEventListener('DOMContentLoaded', loadPosts);

        // --- New Update Button Click Listener ---
        newUpdatesButton.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of the embed
            newUpdatesCount = 0; // Reset new updates count
            newUpdatesButton.style.display = 'none'; // Hide the button
            filterAndRenderPosts(); // Re-render to ensure latest posts are visible
        });

        // --- Message Listener (for communication with parent window/admin page) ---
        window.addEventListener('message', (event) => {
            // IMPORTANT: In a production environment, validate event.origin for security!
            // Example: if (event.origin !== "http://your-admin-domain.com") return;
            
            if (event.data.type === 'refreshEmbed' && event.data.blogId === currentBlogId) {
                console.log('Refreshing embed posts due to admin update message.');
                // The onSnapshot listener will typically handle the actual data refresh,
                // but this message can trigger specific actions or debugging.
            }
        });
    </script>
</body>
</html>
